<?
global $MIOLO;
$MIOLO->Uses('forms/frmUsuario.class','common');

class frmCopiaStatusDeUsuario extends frmUsuario
{
	function __construct()  
	{
		parent::__construct('Copia Status de Usuário');

		$this->SetFieldAttr('mtfGrupos','visible', false);
		$this->SetFieldAttr('lkpNome','readonly', true);
		$this->SetFieldAttr('edtNick','readonly', true);
		$this->SetFieldAttr('selIdSetor','enable', false);
		$this->SetButtonAttr('btnNew','visible', false);
		$this->SetButtonAttr('btnPost','visible', false);
		$this->SetButtonAttr('btnDelete','visible', false);
		$this->SetButtonAttr('btnList','visible', false);
		
		$buttons[] =  new MButton('btnCopiar','Copiar status de Usuário');
		$this->SetButtons($buttons);
        $this->setFieldAttr('btnCopiar','visible',false);
		$this->EventHandler();
	}

	function btnEdit_click($sender, $key='')
	{   
        parent::btnEdit_click($sender,$key);
        $this->setFieldAttr('btnCopiar','visible',true);
        $this->setFieldAttr('btnCancel','visible',false);
	}

	function btnCopiar_click()
	{
		global $auth, $MIOLO,$self;
		
		$newLogin = $this->GetFieldValue('lkpLogin');
        $usuario = $MIOLO->getBusiness('common','usuario');
        $usuario->getByLogin($newLogin);
        $challenge = uniqid(rand());
        $response = md5(trim($usuario->login) . ':' . trim($usuario->passMD5) . ":" . $challenge);

		if(!empty($newLogin))
		{
			$auth->Authenticate($newLogin, $challenge, $response);
			$action = $MIOLO->GetActionURL('common','main');
            $MIOLO->Information("Agora você está logado como {$auth->login->id}&nbsp;({$auth->login->user}).", $action );
		}
	}
}
?>