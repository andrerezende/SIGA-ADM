<?
class frmPassword extends MForm
{
    var $objUsuario;

	function __construct()
    {   global $MIOLO, $module, $page, $context, $self, $action;

        $this->objUsuario = $MIOLO->GetBusiness($module,'usuario');
		parent::__construct('Alteração de senha');
	    $this->EventHandler();
	}

    function CreateFields()
	{  global $auth, $perms, $action;
       $fields = array(
           new MHiddenField('key',''),
	       new MLookupTextField('lkpLogin','','Login',20),
           new MTextLabel('txtLogin','','Login'),
           new MPasswordField('edtSenhaAtual','','Senha Atual',20),
           new MPasswordField('edtSenha1','','Nova Senha',20),
           new MPasswordField('edtSenha2','','Confirmação',20)
       );
	   $this->SetFields($fields);
       if ($perms->checkAccess('password',A_ADMIN))
       {
	      $this->SetFieldAttr('txtLogin','visible',false);
  	      $this->addValidator(new MRequiredValidator('lkpLogin'));
       }
       else
       {
          $login = $auth->GetLogin();
	      $this->SetFieldValue('key',$login->idkey);
	      $this->SetFieldValue('txtLogin',$login->id);
	      $this->SetFieldValue('lkpLogin',$login->id);
	      $this->SetFieldAttr('lkpLogin','visible',false);
       }
	   $this->SetFieldAttr('lkpLogin','module','common');
	   $this->SetFieldAttr('lkpLogin','item','usuario');
	   $this->SetFieldAttr('lkpLogin','event','filler');
	   $this->SetFieldAttr('lkpLogin','related','key,lkpLogin,edtSenhaAtual');
       $buttons = array(
           new MButton('btnPost', 'Enviar')
       );
	   $this->SetButtons($buttons);
       $this->AddValidator(new MRequiredValidator('edtSenhaAtual'));
       $this->AddValidator(new MPasswordValidator('edtSenha1'));
       $this->AddValidator(new MPasswordValidator('edtSenha2'));
	}

	function GetData()  // nome dos formfields != business fields
	{
        $data = new FormData();
		$data->idusuario = $this->GetFieldValue('key');
		$data->login = $this->GetFieldValue('lkpLogin');
		$data->pwdatual = $this->GetFieldValue('edtSenhaAtual');
		$data->pwdnew1 = $this->GetFieldValue('edtSenha1');
		$data->pwdnew2 = $this->GetFieldValue('edtSenha2');
        return $data;
	}

	function SetData($data)
	{
		$this->SetFieldValue('key', $data->idusuario);
		$this->SetFieldValue('lkpLogin', $data->login);
		$this->SetFieldValue('edtSenhaAtual', $data->password);
	}

	function btnPost_click()
	{
		global $MIOLO, $module, $self, $action;
        $data = $this->GetData();
        $objUsuario = $this->objUsuario->GetById($data->idusuario);
        $ok = $objUsuario->ValidatePassword($data->pwdatual);
        if ($ok)
        {
           if ($ok = ($data->pwdnew1 == $data->pwdnew2))
           {
			  $ok = $objUsuario->UpdatePassword($data->pwdnew1);
              if ( $ok )
              {
                 $go = $this->manager->getActionUrl('common','main');
                 $MIOLO->Information('Senha atualizada com sucesso.', $go);
                 return true;
              }
           }
           else
           {
              $this->AddError('Confirmação da senha não confere!');
           }
        }
        $this->AddError($objUsuario->GetErrors());
	}
}

?>
