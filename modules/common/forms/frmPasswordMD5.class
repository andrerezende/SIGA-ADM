<?
class frmPasswordMD5 extends MForm
{
    var $objUsuario;

	function __construct()
    {   global $MIOLO;

        $this->objUsuario = $MIOLO->GetBusiness('common','usuario');
		parent::__construct('Alteração de senha');
        $this->page->AddScript('m_md5.js');
	    $this->EventHandler();
	}

    function CreateFields()
	{  global $MIOLO;

       $this->AddJsCode($this->doCheckSamePassword());
       $this->AddJsCode($this->doStrongPassword());
       $this->AddJsCode($this->doPasswordMD5());
       $this->AddJsCode($this->doChallengeResponse());
       $this->OnSubmit('doStrongPassword()');
       $this->OnSubmit('doPasswordMD5()');
       $this->OnSubmit('doCheckSamePassword()');
       $challenge = uniqid(rand());
       $fields = array(
           new MHiddenField('key',''),
           new MHiddenField('challenge', $challenge),
           new MHiddenField('response', ''),
           new MHiddenField('newpass', ''),
	       new MTextField('txtLogin','','Login',20),
           new MPasswordField('edtSenhaAtual','','Senha Atual',20),
           new MPasswordField('edtSenha1','','Nova Senha',20,'Mínimo de 6 caracteres'),
           new MPasswordField('edtSenha2','','Confirmação',20)
       );
	   $this->SetFields($fields);
           //verifica se admin
       if ($MIOLO->getPerms()->checkAccess('password',A_ADMIN))
       {
               
	      $this->SetFieldAttr('edtSenhaAtual','visible',false); 
	      $this->SetFieldValue('key','0');
              //eder
              $login = $MIOLO->getAuth()->getLogin();
              //recupera o nome(id) do usuário
              $this->SetFieldValue('txtLogin',$login->id);
              //impossibilita a modificação do campo pelo usuário
              $this->SetFieldAttr('txtLogin','readonly',true);
              //obs: quando confirmado como admin o usuário não tinha seu txtLogin setado
              //eder
  	      $this->addValidator(new MRequiredValidator('txtLogin'));
       }
       else
       {
          $login = $MIOLO->getAuth()->getLogin();
	      $this->SetFieldValue('key',$login->idkey);
	      $this->SetFieldValue('txtLogin',$login->id);
	      $this->SetFieldAttr('txtLogin','readonly',true);
          $this->OnSubmit('doChallengeResponse()');
       }
       $buttons = array(
           new MButton('btnPost', 'Enviar Alteração')
       );
	   $this->SetButtons($buttons);
	}

	function GetData()  // nome dos formfields != business fields
	{
        $data = new FormData();
		$data->idusuario = $this->GetFieldValue('key');
		$data->challenge = $this->GetFieldValue('challenge');
		$data->response = $this->GetFieldValue('response');
		$data->newpass = $this->GetFieldValue('newpass');
		$data->login = $this->GetFieldValue('txtLogin');
		$data->pwdatual = $this->GetFieldValue('edtSenhaAtual');
		$data->pwdnew1 = $this->GetFieldValue('edtSenha1');
		$data->pwdnew2 = $this->GetFieldValue('edtSenha2');
        return $data;
	}

	function SetData($data)
	{
		$this->SetFieldValue('key', $data->idusuario);
		$this->SetFieldValue('txtLogin', $data->login);
		$this->SetFieldValue('edtSenhaAtual', $data->password);
	}

	function btnPost_click()
	{
		global $MIOLO, $module, $self, $action;

        $data = $this->GetData();
        $objUsuario = $this->objUsuario->GetByLogin($data->login);
        if ($objUsuario->login != '')
        {
           $ok = $data->idusuario ? $objUsuario->ValidatePasswordMD5($data->challenge,$data->response) : true;
           if ($ok)
           {
		if ($this->GetFieldValue('edtSenha1') != $this->GetFieldValue('edtSenha2'))
			$this->AddError('A confirmação da nova senha não confere!');
		else
			try
			{
				$ok = $objUsuario->UpdatePasswordMD5(md5($data->pwdnew1));
				$this->manager->getLogin()->setUser($objUsuario);
				$this->manager->getAuth()->setLogin($this->manager->getLogin());
				$action = $this->manager->getActionURL('common','main');
				$this->clearFields();
				$this->clearButtons();
				$this->setShowPostButton(false);
				$this->setFields(MPrompt::Information('Senha atualizada com sucesso.', $action));
			} 
			catch( Exception $e )
			{
				$this->AddError('Confirmação da senha não confere!');
			}
	      
           }
           else
           {
               $this->AddError('Senha atual não confere!');
           }
       }
       else
       {
           $this->AddError('Usuário não cadastrado!');
       }
	}

    function doChallengeResponse()
    {
       $code = "function doChallengeResponse() { \n".
               "  var str = MIOLO_GetElementById('txtLogin').value + \":\" + \n" .
               "        MD5(MIOLO_GetElementById('edtSenhaAtual').value) + \":\" + \n" .
               "        MIOLO_GetElementById('challenge').value; \n".
               "  MIOLO_SetElementValueById('edtSenhaAtual','');\n".
               "  MIOLO_SetElementValueById('response',MD5(str));\n".
               "  return true;\n".
               "}\n";
       return $code;
    }

    function doPasswordMD5()
    {
       $code = "function doPasswordMD5() { \n".
               "  MIOLO_SetElementValueById('newpass',MD5(MIOLO_GetElementById('edtSenha1').value));\n".
               "  return true;\n".
               "}\n";
       return $code;
    }

    function doCheckSamePassword()
    {
       $code = "function doCheckSamePassword() { \n".
               "  var ok = (MIOLO_GetElementById('edtSenha1').value == MIOLO_GetElementById('edtSenha2').value);\n".
               "  if ( !ok )\n".
               "  {\n".
               "     alert(\"Nova Senha difere da Confirmação!\");\n".
               "  }\n".
               "  return ok;\n".
               "}\n";
       return $code;
    }

    function doStrongPassword()
    {
       $code = "function doStrongPassword() { \n".
               "  var senha = MIOLO_GetElementById('edtSenha1').value;\n".
               "  var ok = true; \n".
               "  if ( senha.length < 6 )\n".
               "  {\n".
               "     ok = false;\n".
               "     alert(\"Nova senha deve ter no mínimo 6 caracteres!\");\n".
               "  }\n".
	       "else{".
               "  if ( (MIOLO_GetElementById('edtSenhaAtual').value == MIOLO_GetElementById('edtSenha2').value) )\n".
               "  {\n".
               "     ok = false;\n".
               "     alert(\"Nova senha deve ser diferente da atual!\");\n".
               "  }\n".
               "  if ( (MIOLO_GetElementById('edtSenha1').value == '010101') )\n".
               "  {\n".
               "     ok = false;\n".
               "     alert(\"Senha fraca; entre com nova senha!\");\n".
               "  }}\n".
               "  return ok;\n".
               "}\n";
       return $code;
    }

}

?>