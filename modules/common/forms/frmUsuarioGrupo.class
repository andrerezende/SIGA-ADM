<?
class frmUsuarioGrupo extends MForm
{
    var $objUsuario;
    var $objGrupo;
        
    function __construct()
    {   
        global $MIOLO;
        
        $this->objUsuario = $MIOLO->GetBusiness('common','usuario');
        $this->objGrupo = $MIOLO->GetBusiness('common','grupo');
        
        parent::__construct('Associação de grupos à usuários');        
        $this->SetIcon($MIOLO->GetUI()->GetImage('common','user1.png'));
        $this->SetClose($MIOLO->GetActionURL('common','main'));
        $this->EventHandler();
     }
     
     function CreateFields()
     {  
        global $MIOLO, $perms;

        $queryUsuario = $this->objUsuario->ListAllLogins();
        $mtFieldUsuario = array(array('mtusuario','Usuários','',$queryUsuario));
        
        $queryGrupo = $this->objGrupo->ListAll();
        $mtFieldGrupo = array(array('mtgrupo','Grupos','',$queryGrupo->chunkResult()));
        
        // Lista as uos que o usuário tem acesso
        if ($perms->CheckAccess('ADM_FINANCAS',A_EXECUTE))
        {
            $objUo = $MIOLO->GetBusiness('adm','uo');
            $query = $objUo->ListByNomeAtivo(strtoupper($uo), 'S');
        }
        else if ($perms->CheckAccess('ADM_GESTORUO',A_EXECUTE))
        {
            $idUsuario = $MIOLO->GetLogin()->idkey;
            $gestor = $MIOLO->GetBusiness('adm','gestor');
            $query = $gestor->listUoByUsuario($idUsuario);
        }
        
        $permissao = array(1 => 'Requisitante', 2 => 'Gestor', 3 => 'Executor');
        
        $fields = array(          
            new MMultiTextField2('mtfUsuarios',NULL,'Usuários',$mtFieldUsuario,300,true,'vertical'),
            new MMultiTextField2('mtfGrupos',NULL,'Grupos',$mtFieldGrupo,300,true,'vertical'),
            new MSpacer(1),
            new MSeparator(''),
            new MTextHeader('header', 1,'Permissões de U.O.'),
            new MSelection('uo', '','Unidade Orçamentária',$query->chunkResult()),                       
            new MSelection('perm', '','Permissão',$permissao),                       
        );
        
        $this->SetFields($fields);

        $buttons = array(
            new MButton('btnSalvar',   'Salvar')		  
        );
        $this->SetButtons($buttons);
      }
}

?>
