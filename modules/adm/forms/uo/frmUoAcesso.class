<?
class frmUoAcesso extends Form
{

	protected $objUo;
        public $idnovo;


        function __construct($objUo)
    {
		$this->objUo = $objUo;
        $this->Form('Incluir');
        $this->EventHandler();
    }

    function CreateFields()
    {
		$fields = array(
			new LookupTextField('lkpUsuario','','Logins'),
			new TextField('nome','','Nome',50),
			new HiddenField('idUsuario','')
        );
		
        $this->SetFields($fields);
		
	   $this->SetFieldAttr('lkpUsuario','module','common');
	   $this->SetFieldAttr('lkpUsuario','item','usuario');
	   $this->SetFieldAttr('lkpUsuario','event','filler');
	   $this->SetFieldAttr('lkpUsuario','related','idUsuario,lkpUsuario,NULL,NULL,NULL,NULL,nome');
		
		$buttons = array(
        	new FormButton('btnSalvar', 'Incluir')
            );
		$this->SetButtons($buttons);

    }
	
	public function btnSalvar_click()
	{        // identificador do usuário
		 $idUsuario = $this->GetFormValue('idUsuario');
		 $usuario = $this->manager->GetBusiness('common','usuario');
               
		$usuario->GetById($idUsuario);
		$usuario->retrieveAssociation('pessoa');
                $this->objUo->getUsuarios();
               
                if($this->comparaIds($idUsuario)){
                    try 
                    {
                    
                
		       $this->objUo->AddUsuario($usuario);
                       $this->objUo->saveAssociation('usuarios');
		       $this->objUo->Log(OP_INS,"Novo acesso relacionado à UO");
                    }  
                    catch (Exception $e)      
                    {
                        $this->AddError($e->getMessage());
                    }
                }else{
                     $this->AddError('Requisitante já está relacionado à UO');
                }

		//$this->SetFieldValue('lkpUsuario','');
		//$this->SetFieldValue('nome','');
	}
        public function comparaIds($idusario){
            $flag = TRUE; 
            for ($i = 0 ;$i < count($this->objUo->usuarios);$i++){
                      if($this->objUo->usuarios[$i]->idUsuario == $idusario){
                         $flag = false; 
                         break;
                         }
            }
            return $flag;
        }
}
?>