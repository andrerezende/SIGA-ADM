<?

class frmUoNew extends Form {

    function __construct() {
        $this->Form('Incluir Nova Unidade Orçamentária');
        $this->EventHandler();
    }

    function CreateFields() {
        global $MIOLO, $module, $action, $item, $theme, $event;
        $opcoes = array('N' => 'Não', 'S' => 'Sim');

        $fields = array(
            new TextField('sigla', '', 'Sigla', '30', 'Máx. 30 caracteres'),
            new TextField('nome', '', 'Nome', '50', 'Máx. 50 caracteres'),
            new Selection('tipo', '', 'Tipo'),
            new TextField('documentoRef', '', 'Documento'),
            new LookupTextField('lkpSetor', '', 'Setor', 50,NULL,NULL,NULL,'common', 'setor2'),
            new HiddenField('idUsuarioGestor', '', 'Id usuario'),
            new HiddenField('idSetor', '', 'Id setor'),
            new HiddenField('ativo', 'S', ''),
            new Selection('saldoPublico', '', 'Saldo Público', $opcoes),
        );

        $this->SetFields($fields);


//        $this->SetFieldAttr('lkpSetor', 'module', 'common');
//        $this->SetFieldAttr('lkpSetor', 'item', 'setor');
//        $this->SetFieldAttr('lkpSetor', 'event', 'filler');
//        $this->SetFieldAttr('lkpSetor', 'related', 'idSetor,NULL,lkpSetor');

        $tabelaGeral = $this->manager->getBusiness('common', 'tabelageral');
        $query = $tabelaGeral->listByTabela('AD_TIPOUO');

        $this->setFieldAttr('tipo', 'options', $query->result);

        $buttons = array(
            new FormButton('btnNew', 'Incluir Unidade Orçamentária')
        );
        $this->SetButtons($buttons);

        $validators = array(
            new RequiredValidator('sigla'),
            new RequiredValidator('nome'),
        );
        $this->SetValidators($validators);
    }

    function btnNew_click() {
        $sigla = Form::GetFormValue('sigla');
        $nome = Form::GetFormValue('nome');
        $setor = Form::GetFormValue('idSetor');

        if (strlen(trim($sigla)) < 5) {
            $this->AddError("O campo 'sigla' deve conter pelo menos 5 cinco caracteres.");
        } elseif (strlen(trim($nome)) < 5) {
            $this->AddError("O campo 'nome' deve conter pelo menos 5 cinco caracteres.");
        } elseif (!$setor) {
            $this->AddError("Um setor deve ser definido.");
        } else {
            $data = $this->GetData();
            $uo = $this->manager->GetBusiness('adm', 'uo');
            $uo->SetData($data);
            try {
                $uo->save();
                $uo->Log(OP_INS, "Nova UO crida");
                $go = $this->manager->GetActionURL('adm', 'main:uo', $uo->idUo);
                $this->page->Redirect($go);
            } catch (Exception $e) {
                $this->addError($e->getMessage());
            }
        }
    }

}

?>
