<?
class frmRepConRazao extends MForm
{
    function __construct()
    {
        parent::__construct('Relatório ConRazão');
        $this->EventHandler();
		$this->defaultButton = false;
    }

	function CreateFields()
    {
		global $MIOLO, $module, $action, $item, $theme;

		$fields = array(
			new MTextField('ano',date('Y'),'Ano',5),
		);
		$this->SetFields($fields);

		$buttons = array(
			new MButton('btnPost','Gerar Relatório','PDF'),
			new MButton('btnGerarCSV','Gerar Planilha')        
		);
		$this->SetButtons($buttons);
	}

    function btnPost_click()
    {
		global $MIOLO, $module, $item;

		$ui = $MIOLO->GetUI();
        $report = $ui->GetReport($module,'repConRazao');
        $report->Generate();
	}
	
	function btnGerarCSV_click()
	{
		$orcamento = $this->manager->getBusiness('adm','orcamento');
        $ano = $this->GetFormValue('ano');
        
        	
		$consulta = $orcamento->ListByAno($ano);		

        if ( is_array($consulta->result) )
     	{
    		$resultAux[] = array('PTR','FONTE','RUBRICA', 'ESFERA','CRED. DISP.','EMPENHADO','SALDO');
    		foreach ($consulta->result as $result)		  
	    	{
	    		$resultAux[] = array($result[0],$result[1],$result[2],$result[3],$result[4],$result[5],$result[6] );		
	    	}
    	}
    	else 
    	{
    		$consulta->result[] = ""; 
    	}   
			    
	    $consulta->result = $resultAux;
		$consulta->getCSV("Relatório com Razão: $ano");	
	}
}
?>
