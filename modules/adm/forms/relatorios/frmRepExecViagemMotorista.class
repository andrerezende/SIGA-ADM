<?
class frmRepExecViagemMotorista extends Form
{	
	protected $motorista;
	protected $itemveiculo;
    
    function __construct()
    {
        global $MIOLO;
        $this->motorista = $MIOLO->getBusiness('adm','motorista');
        $this->itemveiculo = $MIOLO->getBusiness('adm','itemveiculo');
        $this->Form('Relatório de Viagens Realizadas por Motoristas');
        $this->EventHandler();       
    }

	function CreateFields()
	{		
		$fields = Array(
			new MCalendarField('dataInicio','','Data Inicial',10,'informe a data inicial do relatório.'),
			new MCalendarField('dataFim','','Data Final',10,'informe a data final do relatório.'),
		);
		
		$this->SetFields($fields);
		$buttons = Array
		(
			new FormButton('btnGerarRelatorio', 'Gerar Relatório','pdf'),
			new FormButton('btnGerarCSV', 'Gerar Planilha')
		);
		$this->SetButtons($buttons);
	}
	function btnGerarCSV_click()
	{
		$data = $this->getData();
        
	    //$report = new MEzPDFReport('2','portrait');
        //$h = $report->pdf->getFontHeight(10);
        //$ui = $this->manager->GetUI();
        //$report->pdf->ezImage($ui->GetImage('','logonet.png'),5,50,'none','left',0);
        //$report->pdf->addText(110,810       ,10,'UNIVERSIDADE FEDERAL DE JUIZ DE FORA');
        //$report->pdf->addText(110,810-$h,10,'SISTEMA INTEGRADO DE GESTÃO ACADÊMICA - SIGA');
        //$report->pdf->ezText('RELATÓRIO DE VIAGENS REALIZADAS POR MOTORISTAS',16,array('justification'=>'center'));
        //$report->pdf->addText(200,810-(8*$h),10,"PERÍODO DE ".$data->dataInicio." ATÉ ".$data->dataFim);
        //$report->pdf->ezText('',20);
        //unset($dataRel);
        
        //$options['textCol'] = array(0,0,0);
	    //$options['shaded'] = 1;
	    //$options['showLines'] = 0;
	    //$options['fontSize'] = 11;
	    //$options['width'] = 540;
	    //$options['xPos'] = 'left';
	    //$options['xOrientation'] = 'right';
	    
	    //$cols = array('NOME','RIO DE JANEIRO','BELO HORIZONTE','OUTROS');
	    $dataRel[] = array('NOME','RIO DE JANEIRO','BELO HORIZONTE','OUTROS');

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////	    
	    $motorista = $this->motorista;
	    $itemveiculo = $this->itemveiculo;
	    $nomes = $motorista->ListNomeById()->result;
        $consulta = $motorista->ListNomeById();
	    $totalRj = 0;
	    $totalBh = 0;
	    $totalOutros = 0;
		foreach ( $nomes as $n )
		{
			$nomeMotorista = $n[0];
			$idMotorista = $n[1];
			$rj = 0;
			$bh = 0;
			$outros = 0;
			$viagens = $itemveiculo->listViagensbyMotorista($idMotorista,$data->dataInicio,$data->dataFim)->result; // variavel viagem recebeu a consulta
			if ( $viagens )
			{
				foreach ( $viagens as $v )
				{
					$idMunicipioOrig = $v[0];
					$idMunicipioDest = $v[1];							
					if ( $idMunicipioDest == 4733 )
					{
						switch($idMunicipioOrig)
						{
							case 4123:
								$bh++;
								break;
							case 6001:
								$rj++;
								break;
							default:
								$outros++;							
								break;
						}					
					}
					
					if ( $idMunicipioOrig == 4733 )
					{
						switch($idMunicipioDest)
						{
							case 4123:
								$bh++;
								break;
							case 6001:
								$rj++;
								break;
							default:
								$outros++;							
								break;
						}										
					}				
				}
				$totalRj += $rj;
				$totalBh += $bh;
				$totalOutros += $outros;
				$dataRel[] = array($nomeMotorista,$rj,$bh,$outros);					
			}
		}	    

	    $consulta->result = $dataRel;
		$consulta->getCSV("viagem");
	}

	function btnGerarRelatorio_click()
	{	
		global $MIOLO, $module, $item;
	    /*$data = $this->getData();
        
	    $report = new MEzPDFReport('2','portrait');
        $h = $report->pdf->getFontHeight(10);
        $ui = $this->manager->GetUI();
        $report->pdf->ezImage($ui->GetImage('','logonet.png'),5,50,'none','left',0);
        $report->pdf->addText(110,810       ,10,'UNIVERSIDADE FEDERAL DE JUIZ DE FORA');
        $report->pdf->addText(110,810-$h,10,'SISTEMA INTEGRADO DE GESTÃO ACADÊMICA - SIGA');
        $report->pdf->ezText('RELATÓRIO DE VIAGENS REALIZADAS POR MOTORISTAS',16,array('justification'=>'center'));
        $report->pdf->addText(200,810-(8*$h),10,"PERÍODO DE ".$data->dataInicio." ATÉ ".$data->dataFim);
        $report->pdf->ezText('',20);
        //unset($dataRel);
        
        $options['textCol'] = array(0,0,0);
	    $options['shaded'] = 1;
	    $options['showLines'] = 0;
	    $options['fontSize'] = 11;
	    $options['width'] = 540;
	    $options['xPos'] = 'left';
	    $options['xOrientation'] = 'right';
	    
	    $cols = array('<b>NOME</b>','<b>RIO DE JANEIRO</b>','<b>BELO HORIZONTE</b>','<b>OUTROS</b>');

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////	    
	    $motorista = $this->motorista;
	    $itemveiculo = $this->itemveiculo;
	    $nomes = $motorista->ListNomeById()->result;

	    $totalRj = 0;
	    $totalBh = 0;
	    $totalOutros = 0;
		foreach ( $nomes as $n )
		{
			$nomeMotorista = $n[0];
			$idMotorista = $n[1];
			$rj = 0;
			$bh = 0;
			$outros = 0;
			$viagens = $itemveiculo->listViagensbyMotorista($idMotorista,$data->dataInicio,$data->dataFim)->result; // variavel viagem recebeu a consulta
			if ( $viagens )
			{
				foreach ( $viagens as $v )
				{
					$idMunicipioOrig = $v[0];
					$idMunicipioDest = $v[1];							
					if ( $idMunicipioDest == 4733 )
					{
						switch($idMunicipioOrig)
						{
							case 4123:
								$bh++;
								break;
							case 6001:
								$rj++;
								break;
							default:
								$outros++;							
								break;
						}					
					}
					
					if ( $idMunicipioOrig == 4733 )
					{
						switch($idMunicipioDest)
						{
							case 4123:
								$bh++;
								break;
							case 6001:
								$rj++;
								break;
							default:
								$outros++;							
								break;
						}										
					}				
				}
				$totalRj += $rj;
				$totalBh += $bh;
				$totalOutros += $outros;
				$dataRel[] = array($nomeMotorista,$rj,$bh,$outros);					
			}
		}	    

	    $dataRel[] = array('TOTAL',$totalRj,$totalBh,$totalOutros);
	    
        $report->pdf->ezTable($dataRel,$cols,'',$options);
	    $report->Execute();
	    */
		$report = new MJasperReport('sigaept');

//		$parameters['dataInicio'] = $data->dataInicio; 
//		$parameters['dataFim'] = $data->dataFim; 

		$parameters['dataInicio'] 	= Form::GetFormValue('dataInicio');
		$parameters['dataFim'] 		= Form::GetFormValue('dataFim'); 
       	$parameters['SUBREPORT_DIR']	= $MIOLO->GetConf('home.modules');
       	$parameters['int_pIdUsuario']	= $MIOLO->login->idkey;
       	$parameters['pURL']		= $MIOLO->GetConf('home.url');

             

       	$report->Execute('adm', 'ViagemMotorista', $parameters);
		
    }

}
?>
