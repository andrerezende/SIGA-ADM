<?
class frmRepReqViagens extends MForm
{
	var $timestamp;

	function __construct()
    	{ 
        	parent::__construct('Relatório das Viagens');
        	$this->EventHandler();
		$this->defaultButton = false;
    	}


	function CreateFields()
    	{
		global $MIOLO, $module, $action, $item, $theme;
		$fields = array(
			new MCalendarField('data','','Data da Viagem',15),
			array (new MTextField('origem','','Cidade de Origem',50),new MTextField('ufOrigem','','UF',2)),
			array (new MTextField('destino','','Cidade de destino',50),new MTextField('ufDestino','','UF',2)),
			new MButton('btnPost','Gerar Relatório','PDF'),
			new MSeparator(),
		);
		$this->SetFields($fields);
	}


	function btnPost_click()
   	{
   		global $MIOLO, $module, $item;
		
		$data = $this->GetData();
		
		$objMunicipio = $MIOLO->GetBusiness('common','municipio');
		$objMunicipio2 = $MIOLO->GetBusiness('common','municipio');
		$objUf = $MIOLO->GetBusiness('common','uf');
		$objUf2 = $MIOLO->GetBusiness('common','uf');
		$objUf->GetById(strtoupper($data->ufOrigem));
		$ufOrigem = $objUf->idUF;
		$objUf2->GetById(strtoupper($data->ufDestino));
		$ufDestino = $objUf2->idUF;
	    
	    $objMunicipio->GetIdByNomeEstado(strtoupper($data->origem),$ufOrigem);
	    $idMunicipioOrigem = $objMunicipio->idMunicipio;
	    $objMunicipio2->GetIdByNomeEstado(strtoupper($data->destino),$ufDestino);
	    $idMunicipioDestino = $objMunicipio2->idMunicipio;
	    
		$report = new MJasperReport('sigaept');
		
		$parameters['str_dataSaida'] 	= Form::GetFormValue('data');
		$parameters['str_idMunicipioOrigem'] 	= $idMunicipioOrigem;
		$parameters['str_idMunicipioDestino'] 	= $idMunicipioDestino;
		$parameters['SUBREPORT_DIR']	= $MIOLO->GetConf('home.modules');
       	$parameters['int_pIdUsuario']	= $MIOLO->login->idkey;
       	$parameters['pURL']		= $MIOLO->GetConf('home.url');

        $report->Execute('adm', 'ReqVeiculoPorDataOrigemeDestino', $parameters);  
	}
}
?>
