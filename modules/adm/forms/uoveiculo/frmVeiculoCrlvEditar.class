<?
class frmVeiculoCrlvEditar extends MForm
{	
    private $objCrlv;
    private $placa;
    
    function __construct()
    {        
        parent::__construct('CRLV');
        $this->EventHandler();
    }

    function CreateFields()
    {

        global $MIOLO;
        
        $idCrlv = $_GET['id'];
        $this->objCrlv = $this->manager->getBusiness('adm','veiculocrlv', $idCrlv);
        $this->placa = $_GET['item'];               
        $veiculo = $this->manager->getBusiness('adm','veiculo', $this->placa);                
        $estados = array("AC"=>"Acre", "AL"=>"Alagoas", "AM"=>"Amazonas", "AP"=>"Amapá","BA"=>"Bahia","CE"=>"Ceará","DF"=>"Distrito Federal","ES"=>"Espírito Santo","GO"=>"Goiás","MA"=>"Maranhão","MT"=>"Mato Grosso","MS"=>"Mato Grosso do Sul","MG"=>"Minas Gerais","PA"=>"Pará","PB"=>"Paraíba","PR"=>"Paraná","PE"=>"Pernambuco","PI"=>"Piauí","RJ"=>"Rio de Janeiro","RN"=>"Rio Grande do Norte","RO"=>"Rondônia","RS"=>"Rio Grande do Sul","RR"=>"Roraima","SC"=>"Santa Catarina","SE"=>"Sergipe","SP"=>"São Paulo","TO"=>"Tocantins");
        $array1 = array('A', 'B', 'C', 'D', 'E');            
        $categoria = array_combine($array1, $array1); 
        
	$fields = array	(
			new MTextField('exercicio', $this->objCrlv->exercicio,'Exercício','4','Máx. 4 números'),
                        new MSelection('uf', $this->objCrlv->uf,'UF', $estados),
                        new MSelection('cat', $this->objCrlv->categoria,'Categoria', $categoria),
                        new MTextField('cnpjcpf',$this->objCrlv->cnpjcpf,'CNPJ/CPF', '18','Máx. 18'),
                        new MTextField('nome',$this->objCrlv->nome,'Nome', '45'),
                        new MSelection('ativo', $this->objCrlv->ativo, 'Ativo', array('N' => 'Não', 'S' => 'Sim')),
        );
             			        
  
		
        $this->SetFields($fields);          	   
        
        $this->exercicio->addAttribute('maxlength','4');            
        $this->cnpjcpf->addAttribute('maxlength','18'); 
		
        $buttons = array (
            new FormButton('btnSalvar', 'Salvar'),
            new FormButton('btnExcluir', 'Excluir CRLV')
        );
        $this->SetButtons($buttons);        
       
    }

    public function btnSalvar_click()
    {
                if( preg_match("/\D/", Form::GetFormValue('exercicio')) or  (strlen(Form::GetFormValue('exercicio')) !=4 ) )
		{
			$this->AddError('Informe um exercicio válido.');
		}
                elseif( Form::GetFormValue('uf') == '' )
		{
			$this->AddError('Informe o uf.');
		}
                elseif( Form::GetFormValue('cat') == '')
		{
			$this->AddError('Você deve selecionar a categoria da CRLV');
		}
                elseif( Form::GetFormValue('cnpjcpf') == '' )
		{
			$this->AddError('Informe o CNPJ ou CPF.');
		}
                elseif ( Form::GetFormValue('nome') == '' ) 
		{
			$this->AddError('Informe o nome.');
		}
                elseif( Form::GetFormValue('ativo') == '' )
		{
			$this->AddError('Você deve selecionar se o crlv esta ativo.');
		}
		else{                                                    
                    if(Form::GetFormValue('ativo') == 'S'){
                        $veiculocrlv = $this->manager->GetBusiness('adm','veiculocrlv');
                        $idsAtivos = $veiculocrlv->getIdsCrlvAtivo($this->placa);
                        
                        for($i = 0;$i < count($idsAtivos); $i++){
                            $veiculocrlv->GetById($idsAtivos[$i][0]);
                            $veiculocrlv->ativo = 'N';
                            try
                            {
                                $veiculocrlv->update();
                            }
                            catch (Exception $e)
                            {
                            $this->addError($e->getMessage());
                            }
                        }
                    }
                    $veiculocrlv2 = $this->manager->GetBusiness('adm','veiculocrlv');
                    $veiculocrlv2->GetById($this->objCrlv->idcrlv);
                    $veiculocrlv2->placa = $this->placa;
                    $veiculocrlv2->exercicio = Form::GetFormValue('exercicio');
                    $veiculocrlv2->uf = Form::GetFormValue('uf');
                    $veiculocrlv2->categoria = Form::GetFormValue('cat');
                    $veiculocrlv2->cnpjcpf = Form::GetFormValue('cnpjcpf');
                    $veiculocrlv2->nome = Form::GetFormValue('nome');
                    $veiculocrlv2->ativo = Form::GetFormValue('ativo');
                    try
                    {                            
                            $veiculocrlv2->update();
//                            $veiculo->Log(OP_INS,"Novo veículo criado");
                            $go = $this->manager->GetActionURL('adm','main:veiculo1',$this->placa);
//                            $this->manager->Information('CRLV salva com sucesso.',$go);
//                            $go = $this->manager->getActionURL('adm','main:veiculo:new3',  $placa);                          
                            $this->page->redirect($go);
                    }
                    catch (Exception $e)
                    {
                            $this->addError($e->getMessage());
                    }
                    
                }
    }
    
    public function btnExcluir_click(){
        $this->objCrlv->delete();
        $go = $this->manager->GetActionURL('adm','main:veiculo1',$this->placa);
        $this->page->redirect($go);
    }
            
}
?>
