
    <?ini_set( 'default_charset', 'utf-8');
class frmRepMapRequisicao extends MForm
{
		
     public function __construct() {

        parent::__construct('Requisição');
        $this->EventHandler();
        $this->defaultButton = false;
    }
    function CreateFields()
    {
        global $MIOLO, $item;

        $session = $MIOLO->getSession();
        $session->setValue('listaIdUo',$item);
        $lkpLocalOrigem = new MLookupTextField('requisicao', '', 'Requisição', 20);
        $this->AddField(new MHiddenField('idRequisicao',''));
        //$this->AddField(new MHiddenField('idDestino',''));
        $lkpLocalOrigem->module = 'adm';
        $lkpLocalOrigem->item = 'requisicaouo';
        $lkpLocalOrigem->event = 'filler';
        $lkpLocalOrigem->related = 'idRequisicao,requisicao';


        $this->page->AddJsCode(file_get_contents(dirname(__FILE__) . '/../../ui/js/mask.js'));
       /* $lkpLocalDestino = new MLookupTextField('destino', '', 'Destino', 50);
        $lkpLocalDestino->module = 'adm';
        $lkpLocalDestino->item = 'enderecouo';
        $lkpLocalDestino->event = 'filler';
        $lkpLocalDestino->related = 'idDestino,destino';
        $dataSaida = new CalendarField('dataSaida', '', 'Data de Saída', 10, 'Ex: 01/01/2001');
        $horaSaida = new MTextField('horaSaida','','Hora de Saída', 5,'Ex: 12:50');
        $horaSaida->AddAttribute('onBlur', 'makeMask(this, \'##:##\');');
        $horaSaida->AddAttribute('onKeyUp', 'makeMask(this, \'##:##\');');
        $horaSaida->AddAttribute('maxlength', '5');*/
        $this->AddField($lkpLocalOrigem);
        /*$this->AddField($lkpLocalDestino);
        $this->AddField($dataSaida);
        $this->AddField($horaSaida);*/
        $buttons = array(
            new MButton('btnPost', 'Gerar Relatório'),
        );
        $this->SetButtons($buttons);
	}
    public function btnPost_click() {
        global $MIOLO, $module, $item;
        
        if($this->GetFormValue('idRequisicao') == '' && $this->GetFormValue('requisicao') !='')
          $idRequisicao = $this->GetFormValue('requisicao');
        else
          $idRequisicao = $this->GetFormValue('idRequisicao');
        
        if($this->verificaRequisicao($idRequisicao)){

        $report = new MJasperReport('sigaept');
        $parameters['SUBREPORT_DIR'] = $MIOLO->GetConf('home.modules');
        $parameters['pURL'] = $MIOLO->GetConf('home.url');
        
        $objRequisicao = $this->manager->GetBusiness('adm', 'requisicao');
	$objRequisicao->GetById($idRequisicao);
        $status = $objRequisicao->status;

        $MIOLO->page->AddJsCode('window.open("http://'.$_SERVER['HTTP_HOST']
        . '/relatorios2/repMapRequisicao.php?idRequisicao=' . $idRequisicao . '&status=' . 
        $status . '");');
        }else{
             $this->manager->Error("Requisição não pertence a U.O ou não existe!", '');
        }


	}
        
        public function verificaRequisicao($idRequisicao){
            global $MIOLO, $module, $item;
            $objRequisicao = $this->manager->GetBusiness('adm', 'requisicao');
            $resultado = $objRequisicao->verificaRequisicaoUoImpressao($idRequisicao,$item);
            
            return $resultado;
            
        }
 
}
?>