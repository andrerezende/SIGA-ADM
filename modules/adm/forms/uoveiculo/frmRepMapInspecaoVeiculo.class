
    <?ini_set( 'default_charset', 'utf-8');
class frmRepMapInspecaoVeiculo extends MForm
{
		
     public function __construct() {

        parent::__construct('Inspeção');
        $this->EventHandler();
        $this->defaultButton = false;
    }
    function CreateFields()
    {
        global $MIOLO, $item;

        $session = $MIOLO->getSession();
        $session->setValue('listaIdUo',$item);
        $lkpLocalOrigem = new MLookupTextField('inspecao', '', 'N° da Inspeção', 20);
        $this->AddField(new MHiddenField('idInspecao',''));
        //$this->AddField(new MHiddenField('idDestino',''));
        $lkpLocalOrigem->module = 'adm';
        $lkpLocalOrigem->item = 'uoinspecao';
        $lkpLocalOrigem->event = 'filler';
        $lkpLocalOrigem->related = 'idInspecao,inspecao';


        $this->page->AddJsCode(file_get_contents(dirname(__FILE__) . '/../../ui/js/mask.js'));
        $this->AddField($lkpLocalOrigem);
        $buttons = array(
            new MButton('btnPost', 'Gerar Relatório'),
        );
        $this->SetButtons($buttons);
    }

    public function btnPost_click() {
        global $MIOLO, $module, $item;

        if($this->GetFormValue('inspecao')!=''){
        if($this->GetFormValue('idInspecao'))
          $idInspecao = $this->GetFormValue('idInspecao');
        else
          $idInspecao = $this->GetFormValue('inspecao');
       
        if($this->verificaInspecao($idInspecao)){
        $report = new MJasperReport('sigaept');
        $parameters['SUBREPORT_DIR'] = $MIOLO->GetConf('home.modules');
        $parameters['pURL'] = $MIOLO->GetConf('home.url');
        $objInspecao = $this->manager->getBusiness('adm','inspecao');
        $objInspecao = $objInspecao->GetById($idInspecao);
        
        $MIOLO->page->AddJsCode('window.open("http://'.$_SERVER['HTTP_HOST']
        . '/relatorios2/repMapInspecaoVeiculo.php?idInspecao=' . $idInspecao . '&idSituacaoInspecao=' . $objInspecao->idSituacaoInspecao . '&iduo=' . $item . '");');
       }else{
           $this->manager->Error("Inspeção não pertence a U.O ou não existe!", '');
       }
      }else{
          $this->manager->Error("Digite um Inspeção!", '');
      }
	}
        
        public function verificaInspecao($idInspecao){
            global $MIOLO, $module, $item;
            $objInspecao = $this->manager->GetBusiness('adm', 'inspecao');
            $resultado = $objInspecao->verificaInspecaoUoImpressao($idInspecao,$item);
            return  $resultado;
        }
        
        public function preencherCampo(){
            
        }
 
}
?>