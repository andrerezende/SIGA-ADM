<?
class frmVeiculoCrlvInserir extends MForm
{	
    private $placa;
    
    function __construct()
    {        
        parent::__construct('CRLV');
        $this->EventHandler();
    }

    function CreateFields()
    {

        global $MIOLO;        
       
        $this->placa = $_GET['item'];               
        $veiculo = $this->manager->getBusiness('adm','veiculo', $this->placa);                
        $estados = array("AC"=>"Acre", "AL"=>"Alagoas", "AM"=>"Amazonas", "AP"=>"Amapá","BA"=>"Bahia","CE"=>"Ceará","DF"=>"Distrito Federal","ES"=>"Espírito Santo","GO"=>"Goiás","MA"=>"Maranhão","MT"=>"Mato Grosso","MS"=>"Mato Grosso do Sul","MG"=>"Minas Gerais","PA"=>"Pará","PB"=>"Paraíba","PR"=>"Paraná","PE"=>"Pernambuco","PI"=>"Piauí","RJ"=>"Rio de Janeiro","RN"=>"Rio Grande do Norte","RO"=>"Rondônia","RS"=>"Rio Grande do Sul","RR"=>"Roraima","SC"=>"Santa Catarina","SE"=>"Sergipe","SP"=>"São Paulo","TO"=>"Tocantins");
        $array1 = array('A', 'B', 'C', 'D', 'E');            
        $categoria = array_combine($array1, $array1); 
        
	$fields = array	(
			new MTextField('exercicio','','Exercício','4','Máx. 4 números'),
                        new MSelection('uf', 'BA','UF', $estados),
                        new MSelection('cat', 'B','Categoria', $categoria),
                        new MTextField('cnpjcpf','','CNPJ/CPF', '13','Máx. 18 números'),
                        new MTextField('nome','','Nome', '25'),
                        new MSelection('ativo', 'N', 'Ativo', array('N' => 'Não', 'S' => 'Sim')),
        );
             			        
  
		
        $this->SetFields($fields);          	   
        
        $this->exercicio->addAttribute('maxlength','4');            
        $this->cnpjcpf->addAttribute('maxlength','18'); 
		
        $buttons = array (
            new FormButton('btnSalvar', 'Inserir')            
        );
        $this->SetButtons($buttons);        
       
    }

    public function btnSalvar_click()
    {
                if( preg_match("/\D/", Form::GetFormValue('exercicio')) or  (strlen(Form::GetFormValue('exercicio')) !=4 ) )
		{
			$this->AddError('Informe um exercicio válido.');
		}
                elseif( Form::GetFormValue('uf') == '' )
		{
			$this->AddError('Informe o uf.');
		}
                elseif( Form::GetFormValue('cat') == '')
		{
			$this->AddError('Você deve selecionar a categoria da CRLV');
		}
                elseif( Form::GetFormValue('cnpjcpf') == '' )
		{
			$this->AddError('Informe o CNPJ ou CPF.');
		}
                elseif ( Form::GetFormValue('nome') == '' ) 
		{
			$this->AddError('Informe o nome.');
		}
                elseif( Form::GetFormValue('ativo') == '' )
		{
			$this->AddError('Você deve selecionar se o crlv esta ativo.');
		}
		else{
                    $exercicio = Form::GetFormValue('exercicio'); 
                    $veiculocrlv3 = $this->manager->GetBusiness('adm','veiculocrlv');
                    if($veiculocrlv3->existePlacaExercicio($this->placa, $exercicio)){
                        $this->AddError("Já existe o exercício ".$exercicio." para esta placa.");
                    }else{    
                        if(Form::GetFormValue('ativo') == 'S'){
                            $veiculocrlv = $this->manager->GetBusiness('adm','veiculocrlv');
                            $idsAtivos = $veiculocrlv->getIdsCrlvAtivo($this->placa);

                            for($i = 0;$i < count($idsAtivos); $i++){
                                $veiculocrlv->GetById($idsAtivos[$i][0]);
                                $veiculocrlv->ativo = 'N';
                                try
                                {
                                    $veiculocrlv->update();
                                }
                                catch (Exception $e)
                                {
                                $this->addError($e->getMessage());
                                }
                            }
                        }
                        $veiculocrlv2 = $this->manager->GetBusiness('adm','veiculocrlv');
                        $veiculocrlv2->placa = $this->placa;
                        $veiculocrlv2->exercicio = Form::GetFormValue('exercicio');
                        $veiculocrlv2->uf = Form::GetFormValue('uf');
                        $veiculocrlv2->categoria = Form::GetFormValue('cat');
                        $veiculocrlv2->cnpjcpf = Form::GetFormValue('cnpjcpf');
                        $veiculocrlv2->nome = Form::GetFormValue('nome');
                        $veiculocrlv2->ativo = Form::GetFormValue('ativo');
                        try
                        {                            
                                $veiculocrlv2->save();
                                $go = $this->manager->GetActionURL('adm','main:veiculo1',$this->placa);                         
                                $this->page->redirect($go);
                        }
                        catch (Exception $e)
                        {
                                $this->addError($e->getMessage());
                        }
                    }
                }
    }
}
?>
