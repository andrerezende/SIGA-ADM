<?
class frmUoVeiculoNew extends MForm
{
	function __construct()
	{
		parent::__construct('Associar Veículo');
		$this->EventHandler();
	}

	function CreateFields()
	{
            global $MIOLO;

		
			$fields = array(
                            new HiddenField('veiculo', ''),
                            new MLookupFieldValue('lkpVeiculo', '', 'Veículo', 50)
			);
                        $this->SetFields($fields);
                       
                        
                        $this->SetFieldAttr('lkpVeiculo', 'module', 'adm');
			$this->SetFieldAttr('lkpVeiculo', 'item', 'veiculouo1');
			$this->SetFieldAttr('lkpVeiculo', 'event', 'filler');
                        $this->SetFieldAttr('lkpVeiculo','related','veiculo,lkpVeiculo');
		
			$this->SetValidators($validators);
			$buttons = array(
				new MButton('btnPost', 'Salvar'),
			);
			$this->SetButtons($buttons);
	}
        
        function btnPost_click(){            
            global $MIOLO;  
            $session = $MIOLO->getSession();
            $uoreqid = $session->getValue('uoreqid');
             //$veiculo = $this->manager->GetBusiness('adm','veiculo');
             $veiculouo = $this->manager->GetBusiness('adm','veiculouo');
             
             
             $placa = $this->GetFormValue('veiculo');
            
            //$veiculo->GetById($placa);
             if(!$this->verificaAssociacao($uoreqid, $placa)){
            $veiculouo->idUo = $uoreqid;
            $veiculouo->placa= $placa;
            try
            {
                    //$veiculo->update();
                    $veiculouo->save();
                    $session->setValue('uoreqid', '');
                    $go = $this->manager->GetActionURL('adm','main:uoveiculo',$uoreqid);
                    $this->manager->Information('Veículo Associado a U.O.',$go);
            }
            catch (Exception $e)
            {
                    $this->addError($e->getMessage());
            }
            }else{
                $this->AddError('Veículo já associado a U.O.');
            }
           
        }
        
        public function verificaAssociacao($idUo, $placa){
            global $MIOLO;
            $veiculouo = $this->manager->GetBusiness('adm','veiculouo');
            $ret = $veiculouo->listVeiculouo($idUo, $placa); 
            
            return $ret;
           
        }

}
?>
