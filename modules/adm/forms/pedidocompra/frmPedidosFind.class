<?php

MIOLO::Import('modules::adm::controls::linkpedidocompra');

class frmPedidosFind extends MForm {

    /**
     * Business utilizado
     * @var BusinessAdmPedidoCompra
     */
    public $pedido;
    public $perms;

    public function __construct() {
        global $MIOLO, $module;

        $this->pedido = $MIOLO->GetBusiness($module, 'pedidocompra');
        $this->perms = $MIOLO->getPerms();
        parent::__construct('Pesquisa de Solicitações de Compra');
        $this->SetClose($this->manager->GetActionURL('adm', 'main'));
        $this->eventHandler();
        $this->page->addJsCode(file_get_contents(dirname(__FILE__) . '/../../ui/js/mask.js'));
        $this->page->addJsCode(file_get_contents(dirname(__FILE__) . '/../../ui/js/maskMoney.js'));
    }

    public function CreateFields() {
        global $MIOLO, $module;
        $objInstituicao = $MIOLO->GetBusiness('common', 'instituicao');
        $optionsUG = $objInstituicao->listUG();

        $opcoes = array(
            'pendente' => 'PENDENTE',
            'cancelado' => 'CANCELADO',
            'anexado' => 'ANEXADO',
            'indeferido' => 'INDEFERIDO',
        );
        $grid = $this->manager->GetUI()->GetGrid('adm', 'gridPedidos');
        $grid->SetTitle('Resultados encontrados');

        $fields = array(
            new MSelection('situacao', Form::getFormValue('situacao'), 'Situação', $opcoes),
            new MSelection('instituicao', Form::getFormValue('instituicao'), 'Instituição', $optionsUG->result),
            new MTextField('numpro', Form::getFormValue('numpro'), 'Processo', 28),
            new CalendarField('data', Form::getFormValue('data'), 'Data', 10),
            new MLookupTextField('idMaterial', Form::getFormValue('idMaterial'), 'Material', 70, null, null, 'codMaterial,idMaterial', 'adm', 'materialPermanente'),
            new MLookupTextField('idServico', Form::getFormValue('idServico'), 'Serviço', 70, null, null, 'codServico,idServico,descricao', 'adm', 'servicoExterno'),
            new MHiddenField('codMaterial'),
            new MHiddenField('codServico'),
            new MButton('btnFind', 'Buscar'),
            new MSpacer(1),
            new MButton('btnInserir', 'Incluir Solicitação de Compra'),
            $grid,
        );

        $this->SetFields($fields);
        $this->data->addAttribute('onKeyUp', 'makeMask(this, \'##/##/####\');');
        $this->data->addAttribute('onBlur', 'makeMask(this, \'##/##/####\');');

        $this->defaultButton = false;
        $this->page->onLoad("MIOLO_GetElementById('situacao').focus();");
    }

    public function btnInserir_click() {
        global $MIOLO, $module, $action;

        $go = $MIOLO->GetActionURL($module, 'main:pedidocompra:new');
        $this->page->redirect($go);
    }

}