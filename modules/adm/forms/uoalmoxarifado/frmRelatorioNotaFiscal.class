<?php


class frmRelatorioNotaFiscal extends MForm {

    var $idurl;
    public function __construct() {

        parent::__construct('Relatório Por Nota Fiscal');
        $this->EventHandler();
        $this->defaultButton = false;
    }

    public function CreateFields() {
        global $MIOLO, $module, $action, $item, $theme;
        
        $uo = $this->manager->GetBusiness('adm','uo');
        $result = $uo->ListAlInst2($this->manager->GetLogin()->idkey);
        
        //$this->allInstits = $this->objInstituicao->ListAlInst2();
        $mtField = array(array('mtinstits', 'Lista de U.O', '', $result));
        $mtfUsuarios = new MMultiTextField2('idUo', NULL, 'U.O', $mtField, 300, true, 'vertical');
        $fields = array(
            $mtfUsuarios,
            new MSpacer(1),
            new MTextField('idNotaFiscal', '', 'Nota Fiscal', 27, ""),
            //new Selection('idUo','','U.O',$result->result),
            /*new MLookupTextField('uo', '', 'U.O', 27, NULL, NULL, NULL, 'common', 'instituicao2'),
            new MHiddenField('idUo'),*/
            new MTextField('idContaContabil', '', 'Subelemento', 27, ""),
            /*new MLookupTextField('contacontabil', $contacontabil, 'Conta contábil', 50, NULL, NULL, NULL, 'adm', 'contacontabil'),
            new MHiddenField('idContaContabil'),*/
            new MSpacer(1),
            new MSeparator(''),
            new MTextHeader('header', 1, 'Período da Nota'),
            new MCalendarField('datainicio', '', 'A partir de', 27),
            new MCalendarField('datafim', '', 'Até', 27)
        );

        $this->SetFields($fields);

        $this->SetFieldAttr('contacontabil', 'related', 'idContaContabil,contacontabil');
        
        $buttons = array(
            new MButton('btnPost', 'Gerar Relatório'),
        );
        $this->SetButtons($buttons);

        $buttons = array(
            //new MButton('btnReset', 'Limpar Campos'),
        );
        $this->SetButtons($buttons);
    }

    public function btnPost_click() {
        global $MIOLO, $module, $item, $theme;
        
        $idInstituicao= $this->GetFormValue('idUo');
        
         //var_dump(is_array($idInstituicao));exit;
        $uo = $MIOLO->getBusiness('adm','uo');
         $tamanho1 = count($idInstituicao);
         $listaId = array();
          for ($i = 0; $i < $tamanho1; $i++) {
              $cochetes = array('[', ']');
              $texto = str_replace($cochetes, '', $idInstituicao[$i]);
              $idUoRet = $uo->listaUo($texto);
              $listaId[$i] =(int)$idUoRet->result[0][0];
              
          }
        /* $texto = $idInstituicao;
         $posicaoInicio = strpos($texto, '[');
         
         $text1 = substr($texto, $posicaoInicio+1);
         $posicaoFim = strpos($text1, ']');
         $novoText = substr($text1, 0,$posicaoFim);*/
         
        $idNotaFiscal = $this->GetFormValue('idNotaFiscal');
        $idContaContabil = $this->GetFormValue('idContaContabil');

        $datainicio = $this->GetFormValue('datainicio');
        $datafim = $this->GetFormValue('datafim');
        //var_dump($listaId);exit;

        if($instDestino != "" or $instOrigem != "" or $setorDestino != "" or $setorOrigem != "" ){
        if (($instDestino != "" or $instOrigem != "" ) == ($setorDestino != "" or $setorOrigem != "" )) {
            $this->Error("Instituto e Setor selecionados. Favor selecione somente o Instituto ou o Setor.");
            return;
        }
        
        }
        //Adicionado 09-05-2013
       /* $tamanho1 = count($idInstituicao);
          for ($i = 0; $i <= $tamanho1; $i++) {
              $cochetes = array('[', ']');
              $idInstituicao[$i] = str_replace($cochetes, '', $idInstituicao[$i]);
          }
        $this->idurl = substr($this->idurl, 0, (strlen($idurl)-1));
        
        $urlref = $this->idurl;
        
        }
        $pieces = explode("[", $idInstituicao[$i]);
        var_dump($pieces[0]);var_dump($idInstituicao[$i]);exit;
        $array = array(1, 2, 3, 4, 5);
        $uo = $MIOLO->getBusiness('adm','uo');
        $tamlist = count($idInstituicao);
        for($j = 0; $j < $tamlist; $j++){
            var_dump($idInstituicao[$j]);exit;
            $idUoRet = $uo->listaUo($idInstituicao[$j]);
           $uo = $uo->GetById($idInstituicao[$idUoRet]);
           var_dump($uo->idUo);exit;
	   $arr_retorno = array($uo->idUo=>$uo->idUo,);
        }*/
        $session = $this->manager->session;
        $session->register("idUos");
        $session->setValue("idUos",$listaId);
       
        $MIOLO->page->AddJsCode('window.open("http://' . $_SERVER['HTTP_HOST'] . '/relatorios2/relatorioNotafiscal.php?idUo='
                . $listaId . '&idNotaFiscal=' . $idNotaFiscal . '&idContaContabil=' . $idContaContabil . '&datainicio='
                . $datainicio . '&datafim=' . $datafim . '");');
       

        return;
    }

    //criado por DANILO MERÇON
    public function btnReset_click() {
        global $MIOLO;
        $notaFiscal = $this->setFieldValue('notaFiscal', '');
        $idUo = $this->setFieldValue('idUo', '');
        $idContacontabil = $this->setFieldValue('iidContaContabil', '');

        $datainicio = $this->setFieldValue('datainicio', '');
        $datafim = $this->setFieldValue('datafim', '');
    }

}
?>