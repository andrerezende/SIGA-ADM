<?php


class frmRelatorioNotaFiscal extends MForm {

    var $idurl;
    public function __construct() {

        parent::__construct('Relatório Por Nota Fiscal');
        $this->EventHandler();
        $this->defaultButton = false;
        $this->page->addJsCode(file_get_contents(dirname(__FILE__) . '/../../ui/js/mask.js'));
        $this->page->addJsCode(file_get_contents(dirname(__FILE__) . '/../../ui/js/maskMoney.js'));
    }

    public function CreateFields() {
        global $MIOLO, $module, $action, $item, $theme;
        
        $uo = $this->manager->GetBusiness('adm','uo');
        $result = $uo->ListAlInstUo($this->manager->GetLogin()->idkey);
        
        //$this->allInstits = $this->objInstituicao->ListAlInst2();
        $mtField = array(array('mtinstits', 'Lista de U.O', '', $result));
        $mtfUsuarios = new MMultiTextField2('idUo', NULL, 'U.O', $mtField, 300, true, 'vertical');
        $fields = array(
            $mtfUsuarios,
            new MSpacer(1),
            new MTextField('idNotaFiscal', '', 'Nota Fiscal', 27, ""),
            //new Selection('idUo','','U.O',$result->result),
            /*new MLookupTextField('uo', '', 'U.O', 27, NULL, NULL, NULL, 'common', 'instituicao2'),
            new MHiddenField('idUo'),*/
            new MTextField('idContaContabil', '', 'Subelemento', 27, ""),
            /*new MLookupTextField('contacontabil', $contacontabil, 'Conta contábil', 50, NULL, NULL, NULL, 'adm', 'contacontabil'),
            new MHiddenField('idContaContabil'),*/
            new MSpacer(1),
            new MSeparator(''),
            new MTextHeader('header', 1, 'Período da Nota'),
            new MCalendarField('datainicio', '', 'A partir de', 27),
            new MCalendarField('datafim', '', 'Até', 27)
        );

        $this->SetFields($fields);

        $this->SetFieldAttr('contacontabil', 'related', 'idContaContabil,contacontabil');
        $this->datainicio->addAttribute('onKeyUp', 'makeMask(this, \'##/##/####\');');
        $this->datainicio->addAttribute('onBlur', 'makeMask(this, \'##/##/####\');');
        $this->datafim->addAttribute('onKeyUp', 'makeMask(this, \'##/##/####\');');
        $this->datafim->addAttribute('onBlur', 'makeMask(this, \'##/##/####\');');
        
        $buttons = array(
            new MButton('btnPost', 'Gerar Relatório'),
        );
        $this->SetButtons($buttons);

        $buttons = array(
            //new MButton('btnReset', 'Limpar Campos'),
        );
        $this->SetButtons($buttons);
    }

    public function btnPost_click() {
        global $MIOLO, $module, $item, $theme;
        
        $idInstituicao= $this->GetFormValue('idUo');
        $uo = $MIOLO->getBusiness('adm','uo');
         $tamanho1 = count($idInstituicao);
         $listaId = array();
          for ($i = 0; $i < $tamanho1; $i++) {
              $cochetes = array('[', ']');
              $texto = str_replace($cochetes, '', $idInstituicao[$i]);
              $idUoRet = $uo->listaUo($texto);
              $listaId[$i] =(int)$idUoRet->result[0][0];
              
          }
         
        $idNotaFiscal = $this->GetFormValue('idNotaFiscal');
        $idContaContabil = $this->GetFormValue('idContaContabil');

        $datainicio = $this->GetFormValue('datainicio');
        $datafim = $this->GetFormValue('datafim');
        if($idInstituicao!=""){
        $session = $this->manager->session;
        $session->register("idUos");
        $session->setValue("idUos",$listaId);
       
        $MIOLO->page->AddJsCode('window.open("http://' . $_SERVER['HTTP_HOST'] . '/relatorios2/relatorioNotafiscal.php?idUo='
                . $listaId . '&idNotaFiscal=' . $idNotaFiscal . '&idContaContabil=' . $idContaContabil . '&datainicio='
                . $datainicio . '&datafim=' . $datafim . '");');
        return;
        }else{
            $this->Error("Selecione pelo menos uma unidade orçamentária.");
            return;
        }
    }

    //criado por DANILO MERÇON
   /* public function btnReset_click() {
        global $MIOLO;
        $notaFiscal = $this->setFieldValue('notaFiscal', '');
        $idUo = $this->setFieldValue('idUo', '');
        $idContacontabil = $this->setFieldValue('iidContaContabil', '');

        $datainicio = $this->setFieldValue('datainicio', '');
        $datafim = $this->setFieldValue('datafim', '');
    }*/

}
?>