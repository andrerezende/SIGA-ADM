<?php
class frmUoAlmoxarifadoMaterial extends Form {

	public $objEstoque;

	public function __construct($estoque) {
		$this->objEstoque = $estoque;
		
		$this->Form('Situação do Material');
		$this->EventHandler();
		if ($_POST['updateEstoqueMinimo']) {
			$this->ajax_UpdateEstoqueMinimo();
		}
	}

	public function CreateFields() {
		global $MIOLO;
		$ui = $this->manager->GetUI();
		$this->objEstoque->retrieveAssociation('material');
		$objMovimento = $MIOLO->getBusiness('adm', 'movimento');
		$precoMedio = $objMovimento->GetValorUnitario($this->objEstoque->material->idMaterial);

		if (Form::GetFormValue('form') == 'estorno2006' || Form::GetFormValue('form') == 'baixademateriais') {
			$estoqueMinimo = new MTextLabel('estoquemin', $this->objEstoque->estoqueMin, 'Estoque Mínimo');
		} else {
			$estoqueMinimo = new MDiv('divEstoqueMinimo', array(
				new MText('labelEstoqueMin', '&nbsp;Estoque Mínimo:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'),
				new MTextField('estoqueMin',$this->objEstoque->estoqueMin,'Estoque Mínimo',10,'Ex: 500'),
				new MLinkButton('edtEstoqueMin', 'Atualizar', '#'),
				new MDiv('loading', new MImage('loadingImg', null, $ui->GetImage('','loading.gif')), null, '"style"="display:none"'),
			));
		}

		$fields = array(
			new MTextLabel('descricaoMaterial', $this->objEstoque->material->descricao, 'Descrição'),
			new MTextLabel('codigoMaterial', $this->objEstoque->material->codmaterial, 'Código'),
			new MTextLabel('quantidade', $this->objEstoque->estoque, 'Estoque'),
			new MTextLabel('precoMedio', 'R$ ' . $precoMedio[0], 'Preço médio'), 
                        $estoqueMinimo,
		);

		$this->SetFields($fields);

		$this->defaultButton = false;
		$this->page->addScriptURL($this->manager->GetAbsoluteURL('scripts/jquery.js'));
		$this->page->addScriptURL($this->manager->GetAbsoluteURL('scripts/frmUoAlmoxarifadoMaterial.js'));
	}

	public function ajax_UpdateEstoqueMinimo() {
		$this->objEstoque->estoqueMin = $_POST['estoqueMin'];
		try {
			$this->objEstoque->save();
			return true;
		} catch (Exception $e) {
			return false;
		}
	}
}