<?
class frmMotoristaEditar extends MForm
{
    protected $objMotorista;
	
    function __construct($objMotorista)
    {
        $this->objMotorista = $objMotorista;
        parent::__construct('Dados do Motorista');
        $this->EventHandler();
    }

    function CreateFields()
    {
        $motorista = $this->objMotorista;
        $tabelaGeral = $this->manager->getBusiness('common','tabelageral');
        $categorias = $tabelaGeral->listByTabela('AD_CATEGORIAHABILITACAO')->result;
        //$ativo = array(1 => "SIM", 0 => "NÃO");
        $fields = array	(
            //new MHiddenField('idPessoa',$motorista->idPessoa),
            //new MLookupTextField('lkpPessoa',$motorista->ListByMotoristaNome($this->objMotorista->idMotorista),'Nome',50),
            new MHiddenField('idUsuario'),
            new MLookupTextField('lkplogin',$motorista->ListByMotoristaLogin($this->objMotorista->idMotorista),'Login',50),
            new MTextField('carteiraHab',$motorista->carteiraHab,'Carteira de Habilitação','15','Máx. 15 caracteres'),
            new MSelection('categoria',$motorista->categoria,'Categoria',$categorias),
            new MCalendarField('dataValidade',$motorista->dataValidade,'Data de Validade'),
            new MSelection('ativo', $motorista->ativo, 'Ativo', array('0' => 'Não', '1' => 'Sim')),
            //new MSelection('ativo',$motorista->ativo,'Ativo',$ativo),
        );
		
        $this->SetFields($fields);
        $this->SetFieldAttr('lkpPessoa','module','common');
        $this->SetFieldAttr('lkpPessoa','item','pessoa');
        $this->SetFieldAttr('lkpPessoa','event','filler');
        $this->SetFieldAttr('lkpPessoa','related','idPessoa,lkpPessoa');
        $this->SetFieldAttr('lkplogin','module','common');
        $this->SetFieldAttr('lkplogin','item','Usuario');
        $this->SetFieldAttr('lkplogin','event','filler');
        $this->SetFieldAttr('lkplogin','related','idUsuario, lkplogin');
	   
	$buttons = array (
            new FormButton('btnSalvar', 'Salvar')
        );
        $this->SetButtons($buttons);

        $validators = array (
            new MRequiredValidator('carteiraHab'),
            new MRequiredValidator('dataValidade'),
        );
        $this->SetValidators($validators);
    }

    public function btnSalvar_click()
    {
        $motorista = $this->objMotorista;
	$data = $this->GetData();
        if ($data->categoria)
        {
            $motorista->SetData($data);
            $motorista->ativo = Form::GetFormValue('ativo');
            try
            {
                $motorista->save();
                $motorista->Log(OP_UPD,"Dados de motorista modificados");
                $go = $this->manager->GetActionURL('adm','main:motorista',$motorista->idMotorista);
                $this->manager->Information('Motorista alterado com sucesso',$go);
            }
            catch (Exception $e)
            {
                $this->addError($e->getMessage());
            }
        }
        else
        {
            $this->addError('Você deve selecionar uma categoria');
        }
    }
}
?>
