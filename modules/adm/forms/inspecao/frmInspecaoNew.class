<?php
class frmInspecaoNew extends MForm
{
	function __construct()
	{
		parent::__construct('Incluir Inspeção');
		$this->EventHandler();
	}


	function CreateFields()
	{
                $motorista = $this->manager->GetBusiness('adm','motorista');
                $veiculo = $this->manager->GetBusiness('adm','veiculo');
                
                $resultveiculo = $veiculo->listModeloPlaca();
                $optionsveiculo = $resultveiculo->chunkResult();
                $result = $motorista->ListMotoristaNome();
                $options = $result->chunkResult();
		
			$fields = array(
				new MSelection('motorista','','Motorista',$options),
                                new MSelection('veiculo','','Veículo',$optionsveiculo)
			);
		
			$this->SetFields($fields);
			/*$this->nome->setReadOnly(true);
			$validators = array(
				new MRequiredValidator('descricao'),
			);*/
			$this->SetValidators($validators);
			$buttons = array(
				new MButton('btnSalvar', 'Salvar'),
                                new MButton('btnCancelar', 'Cancelar')
			);
			$this->SetButtons($buttons);
	}


	function btnSalvar_click()
	{
		$data = $this->GetData();
		$inspecao = $this->manager->getBusiness('adm','inspecao');
		try
		{
			$inspecao->beginTransaction();
			$inspecao->setData($data);
			$inspecao->setStatus(1);
			$inspecao->dataHoraInicio = date('d/m/Y H:i');
			$inspecao->idVeiculo= Form::GetFormValue('veiculo');
			$inspecao->idMotorista = Form::GetFormValue('motorista');
			$inspecao->save();
			$inspecao->endTransaction();
			$inspecao->Log(OP_INS,'Nova inspeção agendada.');
			$this->manager->information("Nova inspeção agendada, número: ".$inspecao->idInspecao,$this->manager->getActionUrl('adm','main:inspecao:find') );
		}
		catch (Exception $e)
		{
			$this->AddError($e->GetMessage());
		}
	}
}
?>
