<?php
// 19/10/2010 - Vitor Pacheco
class frmRepDepreciacaoPorContaContabil extends MForm
{
	public function __construct()
	{
		parent::__construct('Relatório Acumulado de Valor Depreciado por Contas Contábeis');
		$this->EventHandler();
		$this->defaultButton = false;
	}
	public function CreateFields()
	{
		global $MIOLO, $module, $action, $item, $theme;

        $fields = array(
            new MSelection('mesReferencia', '','Mês referência',$this->geraMeses()),
            new MSelection('anoReferencia', '','Ano referência',$this->geraAnos()),
            new MLookupTextField('instituicao', '', 'Instituição', 30, NULL, NULL, NULL, 'common', 'instituicao2'),
            new MHiddenField('idinstituicao'),
            new MHiddenField('sigla'),
		);
    $this->SetFields($fields);
    $options=array('Ativos','Estornados');

    $this->AddField(new MSeparator(''));
    $this->AddField(new MTextHeader('header', 1,'Situação dos Itens'));

    $opcao=$this->AddField( new MRadioButtonGroup('situacao', '', $options,'Ativos'));

    $this->SetFieldAttr('instituicao', 'related', 'idinstituicao,instituicao,sigla');
    $buttons = array(
			new MButton('btnPost', 'Gerar Relatório', ''),
		);
		$this->SetButtons($buttons);
	}
	public function btnPost_click()
    {
		global $MIOLO, $module, $item;

	//$report = new MJasperReport('sigaept');
        //$parameters['SUBREPORT_DIR'] = $MIOLO->GetConf('home.modules');
        $parameters['pIdUsuario'] = $MIOLO->login->idkey;
       // $parameters['pURL'] = $MIOLO->GetConf('home.url');

        $parameters['int_idInstituicao'] = trim(Form::GetFormValue('idinstituicao'));
        $instituicao = Form::GetFormValue('instituicao');
        $instituicao = explode('-', $instituicao);
        $parameters['instituicao'] = trim($instituicao[0]);
        $instituicao[1] = ereg_replace("[^a-zA-Z0-9_]", "", strtr($instituicao[1], "áàãâéêíóôõúüçÁÀÃÂÉÊÍÓÔÕÚÜÇ ", "aaaaeeiooouucAAAAEEIOOOUUCC"));
        $parameters['unidade'] = trim($instituicao[1]);

        $mesReferencia = Form::GetFormValue('mesReferencia');
        $anoReferencia = Form::GetFormValue('anoReferencia');
        $situacao=Form::GetFormValue('situacao');
	if ($mesReferencia < 10) {
            $mesReferencia = '0' . $mesReferencia;
        }
        $parameters['mesRelatorio'] = $mesReferencia . '/' . $anoReferencia;

        if (empty($mesReferencia)) {
            $this->addError("Selecione o mês referência do relatóio.");
            return false;
        } elseif (empty($anoReferencia)) {
            $this->addError("Selecione o ano referência do relatóio.");
            return false;
        } else {
            $parameters['mesRelatorio'] = '01/' . $parameters['mesRelatorio'];
        }

        if (empty($parameters['int_idInstituicao'])) {
            unset($parameters['instituicao']);
            unset($parameters['unidade']);
            unset($parameters['int_idInstituicao']);
           // $report->Execute($module, 'repValorDepreciadoPorContasContabeisRetrato2', $parameters);
//            $report->Execute($module, 'repValorDepreciadoPorContasContabeis2', $parameters);
	    $idUsuario= $parameters['pIdUsuario'];
	    $idInstituicao=$parameters['int_idInstituicao'];
	    $unidade= $parameters['unidade'];
	    $mesRelatorio=$parameters['mesRelatorio'];
	    $retrato=2;

	    header("Location: http://".$_SERVER['HTTP_HOST']."/relatorios2/view/itemPatrimonio/vw_repDepreciacaoPorContaContabil.php?idusuario=$idUsuario&idInstituicao=$idInstituicao&unidade=$unidade&mesReferencia=$mesReferencia&anoReferencia=$anoReferencia&situacao=$situacao&mesRelatorio=$mesRelatorio&retrato=$retrato");
        } else {
           // $report->Execute($module, 'repValorDepreciadoPorContasContabeisRetrato', $parameters);
//            $report->Execute($module, 'repValorDepreciadoPorContasContabeis', $parameters);
	    $idUsuario= $parameters['pIdUsuario'];
	    $idInstituicao=$parameters['int_idInstituicao'];
	    $unidade= $parameters['unidade'];
	    $mesRelatorio=$parameters['mesRelatorio'];
	    $retrato=1;

	     header("Location: http://".$_SERVER['HTTP_HOST']."/relatorios2/view/itemPatrimonio/vw_repDepreciacaoPorContaContabil.php?idusuario=$idUsuario&idInstituicao=$idInstituicao&unidade=$unidade&mesReferencia=$mesReferencia&anoReferencia=$anoReferencia&situacao=$situacao&mesRelatorio=$mesRelatorio&retrato=$retrato");
        }
	}
    public function geraMeses() {
        global $MIOLO;
        $meses = array(
            1 => 'Janeiro',
            2 => 'Fevereiro',
            3 => 'Março',
            4 => 'Abril',
            5 => 'Maio',
            6 => 'Junho',
            7 => 'Julho',
            8 => 'Agosto',
            9 => 'Setembro',
            10 => 'Outubro',
            11 => 'Novembro',
            12 => 'Dezembro',
        );
        return $meses;
    }
    public function geraAnos() {
        $anos = array();
        $anoAtual = date('Y');
        $anoInicial = $anoAtual - 40;
        for ($i = $anoAtual; $i >= $anoInicial; --$i) {
            $anos[(int) $i] = (int) $i;
        }
        return $anos;
    }
}
?>
