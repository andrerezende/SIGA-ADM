<?php
class frmRepRMBConsolidado extends MForm {
protected $objInstituicao;
protected $allInstits;
public $teste;
protected $mtfUsuarios;

public function __construct() {
global $MIOLO;
$this->objInstituicao = $MIOLO->GetBusiness('common','instituicao');
parent::__construct('Relatório de Movimento de Bens Consolidado');
$this->EventHandler();
$this->defaultButton = false;
}

public function CreateFields() {
global $MIOLO, $module, $action, $item, $theme;

$teste = array();
$this->allInstits = $this->objInstituicao->ListAlInst2();
       $mtField = array(array('mtinstits','Instituições','',$this->allInstits));
$mtfUsuarios = new MMultiTextField2('mtfinstituicoes',NULL,'Instituicoes',$mtField,300,true,'vertical');
//$this->mtfUsuarios = new MMultiSelection('mtfinstituicoes', NULL, 'Instituições', $this->allInstits);
$fields = array(
    $mtfUsuarios,
            new MSelection('mesReferencia', '','Mês referência',$this->geraMeses()),
            new MSelection('anoReferencia', '','Ano referência',$this->geraAnos()),
            //new MCalendarField('datafiscal', '', 'Data da nota fiscal', 27),
            //new MCalendarField('dataateste', '', 'Data de ateste', 27),
            //new MCalendarField('datalancamento', '', 'Data de lançamento', 27),

);
        $this->SetFields($fields);
        $buttons = array(
new MButton('btnPost', 'Gerar Relatório', ''),
//new MImageButton('Name', 'Label', 'http://local.relatorios/rmb_consolidado.php?ref=01%2F05%2F2010', 'Text', '_new'),
);
$this->SetButtons($buttons);


}

public function btnPost_click() {
global $MIOLO;
$mesReferencia = Form::GetFormValue('mesReferencia');
$anoReferencia = Form::GetFormValue('anoReferencia');
$instituicoes = Form::GetFormValue('mtfinstituicoes');
//$datafiscal = Form::GetFormValue('datafiscal');
//$dataateste = Form::GetFormValue('dataateste');
//$datalancamento = Form::GetFormValue('datalancamento');

if (!$instituicoes){
$this->addError('Selecione pelo menos uma instituição.');
return false;
}

if (!$instituicoes){
$this->addError('Selecione pelo menos uma instituição.');
return false;
}

//24-04-2012 Tiago Macedo
//retira cochetes para busca no banco
foreach($instituicoes as &$word) {
$cochetes = array('[',']');
$word = str_replace($cochetes, '', $word);
}

$idinstits = $this->objInstituicao->getIDInstArray($instituicoes);

foreach ($idinstits as $ids){
$idurl = $idurl.$ids.',';
}
$idurl = '('.substr($idurl, 0, (strlen($idurl)-1)).')';
if ($mesReferencia == null || $anoReferencia == null) {
$this->addError('Selecione mês e ano referência do relatório.');
return false;
}

if ($mesReferencia < 10) {
$mesReferencia = '0' . $mesReferencia;
}
$mesRelatorio = '01/' . $mesReferencia . '/' . $anoReferencia;

//24-04-2012 Tiago Macedo
$urlref = $mesRelatorio.'-'.$idurl;
$this->page->AddJsCode('window.open("http://'.$_SERVER['HTTP_HOST'].'/relatorios/rmb_consolidado.php?ref='. urlencode($urlref).'");');
}


public function geraMeses() {
        global $MIOLO;
        $meses = array(
            1 => 'Janeiro',
            2 => 'Fevereiro',
            3 => 'Março',
            4 => 'Abril',
            5 => 'Maio',
            6 => 'Junho',
            7 => 'Julho',
            8 => 'Agosto',
            9 => 'Setembro',
            10 => 'Outubro',
            11 => 'Novembro',
            12 => 'Dezembro',
        );
        return $meses;
    }

    public function geraAnos() {
        $anos = array();
        $anoAtual = date('Y');
        $anoInicial = 1970;
        for ($i = $anoAtual; $i >= $anoInicial; --$i) {
            $anos[(int) $i] = (int) $i;
        }
        return $anos;
    }
}