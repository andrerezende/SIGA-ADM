<?php
// 08/11/2011 - Daniel Bonfim
class frmRepItensPatrimonio_Empenho extends MForm {
	/**
	 * Business utilizado
	 * @var frmRepItensPatrimonio_Empenho
	 */

	public function  __construct() {
		global $MIOLO, $module;
		parent::__construct('Filtragem por Empenho');
		$this->defaultButton = false;
		//$this->page->addJsCode(file_get_contents(dirname(__FILE__).'/js/frmPedidoNew.js'));
		$this->EventHandler();
	}

	public function  CreateFields() {
		global $MIOLO, $page, $module, $context, $action, $history;
		parent::CreateFields();
                  

                $orderby = Form::GetFormValue('orderby');
                $opcoes = array(
                                 "i.iditempatrimonio"=>"Nº Tombo",
                                 "i.descricao"=>"Descrição",                                
                                );
                
		$fields = array(
                    new MTextField("txEmpenho", '', "Número Empenho", "20"),
                    new MLookupTextField('idVidaUtil', '', 'Conta Contábil', 10, NULL, NULL, NULL, 'adm', 'ContaContabil'),
                                        
                    new MSelection('orderby', $orderby,'Ordenar por', $opcoes)
		);  
                
		$this->SetFields($fields);
                $this->SetFieldAttr('idVidaUtil', 'related', 'idVidaUtil');               
                                
		$buttons = array(
			new MButton('btnPost','Gerar Relatório'),
                        new MButton('btnLimpar','Limpar'),
		);
                
		$this->SetButtons($buttons);
                 
                /*
		// Validadores
		$validators = array(
                        new MRequiredValidator('instituicao'),
                        new MRequiredValidator('idVidaUtil'),
                        new MRequiredValidator('orderby'),
		);	//$this->setValidators($validators);
*/

		
		$this->page->onLoad("MIOLO_GetElementById('idVidaUtil').focus();");
	}
        
        
        function btnLimpar_click() {
            
            $this->SetFieldValue('txEmpenho', "");
            $this->SetFieldValue('idVidaUtil', "");
        }
        

    function btnPost_click()
    {        
	global $MIOLO, $module, $item, $theme;
        
        $filtradoPor = "empenho";
        $empenho = Form::GetFormValue('txEmpenho');
        $idVidaUtil = Form::GetFormValue('idVidaUtil');
        $orderby = (Form::GetFormValue('orderby')) ? Form::GetFormValue('orderby') : 'i.iditempatrimonio';
        
        if(!$empenho) {
            $this->Error("Número Empenho não informado.");
            return;            
        } 
        
        if(!is_numeric($empenho)) {
            $this->Error("Insira apenas números no campo Empenho.");
            return; 
        }
        
        header("Location: http://".$_SERVER['HTTP_HOST']."/relatorios2/repItensPatrimonio.php?filtradoPor=$filtradoPor&numeroEmpenho=$empenho&idVidaUtil=$idVidaUtil&orderby=$orderby");
        
    }

	
}
?>