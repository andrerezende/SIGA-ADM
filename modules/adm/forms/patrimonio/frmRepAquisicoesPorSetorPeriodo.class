<?

class frmRepAquisicoesPorSetorPeriodo extends MForm {

    function __construct() {
        parent::__construct('Relatório de Aquisições por Setor no Período');
        $this->EventHandler();
        $this->defaultButton = false;
        $this->page->addJsCode(file_get_contents(dirname(__FILE__) . '/../../ui/js/mask.js'));
        $this->page->addJsCode(file_get_contents(dirname(__FILE__) . '/../../ui/js/maskMoney.js'));
    }

    function CreateFields() {
        global $MIOLO, $module, $action, $item, $theme, $event;

        $fields = array(
            new MLookupTextField('setor', '', 'Setor*', 20, NULL, NULL, NULL, 'common', 'setor2'),
            new MCalendarField('dataInicial', '', 'A partir de*', 20),
            new MCalendarField('dataFinal', '', 'Até*', 20),
            new MHiddenField('idSetor'),
        );
//        $this->AddValidator( new RequiredValidator('setor') );
        $this->SetFields($fields);
        $this->dataInicial->addAttribute('onKeyUp', 'makeMask(this, \'##/##/####\');');
        $this->dataInicial->addAttribute('onBlur', 'makeMask(this, \'##/##/####\');');
        $this->dataFinal->addAttribute('onKeyUp', 'makeMask(this, \'##/##/####\');');
        $this->dataFinal->addAttribute('onBlur', 'makeMask(this, \'##/##/####\');');
        $this->SetFieldAttr('setor', 'module', 'common');
//        $this->SetFieldAttr('setor', 'item', 'setor');
        $this->SetFieldAttr('setor', 'related', 'idSetor,setor');

        $buttons = array(
            new MButton('btnPost', 'Gerar Relatório', ''),
        );
        $this->SetButtons($buttons);
    }

    function btnPost_click() {
        global $MIOLO, $module, $item;

        $report = new MJasperReport('sigaept');
        $parameters['SUBREPORT_DIR'] = $MIOLO->GetConf('home.modules');
        $parameters['int_pIdUsuario'] = $MIOLO->login->idkey;
        $parameters['pURL'] = $MIOLO->GetConf('home.url');
        $parameters['pDataIni'] = Form::GetFormValue('dataInicial');
        $parameters['pDataFim'] = Form::GetFormValue('dataFinal');
        $parameters['int_pSetor'] = Form::GetFormValue('idSetor');

        /* $date = Form::GetFormValue('dataInicial'); 
          $token = explode("/",$date);
          $date = $token[2]."/".$token[1]."/".$token[0];
          $parameters['pDataIni'] = $date;

          $date = Form::GetFormValue('dataFinal');
          $token = explode("/",$date);
          $date = $token[2]."/".$token[1]."/".$token[0];
          $parameters['pDataFim'] = $date; */


        //var_dump($parameters);
        //report->Execute($module, 'vw_repAquisicaoSetorPorPeriodo', $parameters);
        //$teste='teste';
        $datainicial = Form::GetFormValue('dataInicial');
        $datafinal = Form::GetFormValue('dataFinal');
        $setor = Form::GetFormValue('idSetor');

        if ($setor < 1) {
            $setor = '' . $setor;
        }
        $parameters['idSetor'] = $setor;

        if (empty($setor)) {
            $this->addError("Selecione o setor do relatóio.");
            return false;
        } else {
            $parameters['idSetor'] = $parameters['idSetor'];
        }


        if (empty($datainicial)) {
            $this->addError("Selecione a data inicial do relatóio.");
            return false;
        } elseif (empty($datafinal)) {
            $this->addError("Selecione a data final do relatóio.");
            return false;
        } else {
            $parameters['dataInicial'] = '01/' . $parameters['dataInicial'];



            $MIOLO->page->AddJsCode('window.open("http://' . $_SERVER['HTTP_HOST']
                    . '/relatorios2/view/itemPatrimonio/vw_repAquisicaoPorSetorPeriodo.php?dataInicial=' . $parameters['pDataIni'] .
                    '&dataFinal=' . $parameters['pDataFim'] . '&idSetor=' . $parameters['int_pSetor'] . '");');
        }
    }

}

?>
