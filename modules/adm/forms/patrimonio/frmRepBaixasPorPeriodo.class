<?php

ini_set('default_charset', 'utf-8');

class frmRepBaixasPorPeriodo extends MForm {

    protected $objInstituicao;
    protected $allInstits;

    function __construct() {
        global $MIOLO;
        $this->objInstituicao = $MIOLO->GetBusiness('common', 'instituicao');
        parent::__construct('Relatório de Baixas no Período');
        $this->EventHandler();
        $this->defaultButton = false;
    }

    function CreateFields() {
        global $MIOLO, $module, $action, $item, $theme;

        $this->allInstits = $this->objInstituicao->ListAlInst2();
        $mtField = array(array('mtinstits', 'Instituições(*)', '', $this->allInstits));
        $mtfUsuarios = new MMultiTextField2('mtfinstituicoes', NULL, 'Instituicoes', $mtField, 300, true, 'vertical');

        $fields = array(
            //new MTextField('idRubrica','','Rubrica',20,'999999.99'),
            $mtfUsuarios,
            new MCalendarField('dataInicial', '', 'A partir de(*)', 20),
            new MCalendarField('dataFinal', '', 'Até(*)', 20),
        );
        $this->SetFields($fields);

        $buttons = array(
            new MButton('btnPost', 'Gerar Relatório', ''),
        );
        $this->SetButtons($buttons);
    }

    function btnPost_click() {
        global $MIOLO, $module, $item;

        $inst = Form::GetFormValue('mtfinstituicoes');
        $datainicio = Form::GetFormValue('dataInicial');
        $datafim = Form::GetFormValue('dataFinal');
//          $report = new MJasperReport('sigaept');
//        $parameters['SUBREPORT_DIR'] = $MIOLO->GetConf('home.modules');
//        $parameters['int_pIdUsuario'] = $MIOLO->login->idkey;
        
        if (!$inst) {
            $this->addError('Selecione palo menos uma instituição.');
            return false;
        }

        if (!$datainicio) {
            $this->addError('Escolha um período de inicio.');
            return false;
        }

        if (!$datafim) {
            $this->addError('Escolha um período final.');
            return false;
        }

        foreach ($inst as &$word) {
            $cochetes = array('[', ']');
            $word = str_replace($cochetes, '', $word);
            $instituicoes .= ucwords(mb_strtolower(substr($word, 10), 'utf-8')) . ',';
        }

        $idinstits = $this->objInstituicao->getIDInstArray($inst);

        foreach ($idinstits as $ids) {
            $idurl = $idurl . $ids . ',';
        }
        $idurl = '(' . substr($idurl, 0, (strlen($idurl) - 1)) . ')';
        $instituicoes = substr($instituicoes, 1, (strlen($instituicoes) - 2));

        $MIOLO->page->AddJsCode('window.open("http://'.$_SERVER['HTTP_HOST']
                    .'/relatorios2/repBaixasPorPeriodo.php?datainicio='. $datainicio . '&datafim=' 
                    . $datafim . '&instituicoes=' . $instituicoes . '&inst='. $idurl. '");');

        /* $report = new MJasperReport('sigaept');
          $parameters['SUBREPORT_DIR']	= $MIOLO->GetConf('home.modules');
          $parameters['int_pIdUsuario']	= $MIOLO->login->idkey;
          $parameters['pURL']		= $MIOLO->GetConf('home.url');
          $parameters['pDataIni'] 	= Form::GetFormValue('dataInicial');
          $parameters['pDataFim']	= Form::GetFormValue('dataFinal');
          $parameters['pinsts']	= $idurl; */
        /* $date = Form::GetFormValue('dataInicial'); 
          $token = explode("/",$date);
          $date = $token[2]."/".$token[1]."/".$token[0];
          $parameters['pDataIni'] = $date;

          $date = Form::GetFormValue('dataFinal');
          $token = explode("/",$date);
          $date = $token[2]."/".$token[1]."/".$token[0];
          $parameters['pDataFim'] = $date; */


        //var_dump($parameters);
        //$report->Execute($module, 'repBaixasPorPeriodo', $parameters);
    }

}

?>
