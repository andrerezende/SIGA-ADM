<?php


class frmRelatorioNotaFiscal extends MForm {

    public function __construct() {

        parent::__construct('Relatório Por Nota Fiscal');
        $this->EventHandler();
        $this->defaultButton = false;
    }

    public function CreateFields() {
        global $MIOLO, $module, $action, $item, $theme;
        
        $uo = $this->manager->GetBusiness('adm','uo');
        $result = $uo->ListAlmoxarifadosUsuario($this->manager->GetLogin()->idkey);
        $fields = array(
            new MSpacer(1),
            new MTextField('idNotaFiscal', '', 'Nota Fiscal', 27, ""),
            new Selection('idUo','','U.O',$result->result),
            /*new MLookupTextField('uo', '', 'U.O', 27, NULL, NULL, NULL, 'common', 'instituicao2'),
            new MHiddenField('idUo'),*/
            new MLookupTextField('contacontabil', $contacontabil, 'Conta contábil', 50, NULL, NULL, NULL, 'adm', 'contacontabil'),
            new MHiddenField('idContaContabil'),
            new MSpacer(1),
            new MSeparator(''),
            new MTextHeader('header', 1, 'Período da Nota'),
            new MCalendarField('datainicio', '', 'A partir de', 27),
            new MCalendarField('datafim', '', 'Até', 27)
        );

        $this->SetFields($fields);

        $this->SetFieldAttr('contacontabil', 'related', 'idContaContabil,contacontabil');
        
        $buttons = array(
            new MButton('btnPost', 'Gerar Relatório'),
        );
        $this->SetButtons($buttons);

        $buttons = array(
            //new MButton('btnReset', 'Limpar Campos'),
        );
        $this->SetButtons($buttons);
    }

    public function btnPost_click() {
        global $MIOLO, $module, $item, $theme;
        $idUo = $this->GetFormValue('idUo');
        $idNotaFiscal = $this->GetFormValue('idNotaFiscal');
        $idContaContabil = $this->GetFormValue('idContaContabil');

        $datainicio = $this->GetFormValue('datainicio');
        $datafim = $this->GetFormValue('datafim');
        

        if($instDestino != "" or $instOrigem != "" or $setorDestino != "" or $setorOrigem != "" ){
        if (($instDestino != "" or $instOrigem != "" ) == ($setorDestino != "" or $setorOrigem != "" )) {
            $this->Error("Instituto e Setor selecionados. Favor selecione somente o Instituto ou o Setor.");
            return;
        }
        
        }
        $MIOLO->page->AddJsCode('window.open("http://' . $_SERVER['HTTP_HOST'] . '/relatorios2/relatorioNotafiscal.php?idUo='
                . $idUo . '&idNotaFiscal=' . $idNotaFiscal . '&idContaContabil=' . $idContaContabil . '&datainicio='
                . $datainicio . '&datafim=' . $datafim . '");');
       

        return;
    }

    //criado por DANILO MERÇON
    public function btnReset_click() {
        global $MIOLO;
        $notaFiscal = $this->setFieldValue('notaFiscal', '');
        $idUo = $this->setFieldValue('idUo', '');
        $idContacontabil = $this->setFieldValue('iidContaContabil', '');

        $datainicio = $this->setFieldValue('datainicio', '');
        $datafim = $this->setFieldValue('datafim', '');
    }

}
?>