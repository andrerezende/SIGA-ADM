<?php

// 19/10/2010 - Vitor Pacheco
class frmRepItensTransferencia extends MForm {

    public function __construct() {

        parent::__construct('Relatório de Transferência de Itens Patrimoniais');
        $this->EventHandler();
        $this->defaultButton = false;
    }

    public function CreateFields() {
        global $MIOLO, $module, $action, $item, $theme;


        $fields = array(
            new MSpacer(1),
            new MTextField('tombo', '', 'Tombo do Item', 27, ""),
            new MLookupTextField('instOrigem', '', 'Instituição de Origem', 27, NULL, NULL, NULL, 'common', 'instituicao2'),
            new MHiddenField('idInstOrigem'),
            new MLookupTextField('instDestino', '', 'Instituição de Destino', 27, NULL, NULL, NULL, 'common', 'instituicao2'),
            new MHiddenField('idInstDestino'),
            new MSpacer(1),
            new MSeparator(''),
            new MSpacer(1),
            new MLookupTextField('setorOrigem', '', 'Setor de Origem', 27, NULL, NULL, NULL, 'common', 'setor'),
            new MHiddenField('idSetorOrigem'),
            new MLookupTextField('setorDestino', '', 'Setor de Destino', 27, NULL, NULL, NULL, 'common', 'setor'),
            new MHiddenField('idSetorDestino'),
            new MSpacer(1),
            new MSeparator(''),
            new MTextHeader('header', 1, 'Período da Transferência'),
            new MCalendarField('datainicio', '', 'A partir de', 27),
            new MCalendarField('datafim', '', 'Até', 27)
        );

        $this->SetFields($fields);


        $this->SetFieldAttr('setorOrigem', 'item', 'setor');
        $this->SetFieldAttr('setorOrigem', 'related', 'idSetorOrigem,setorOrigem');
        $this->SetFieldAttr('idSetorOrigem', 'related', 'idSetorOrigem,idsetor');

        //-----------------------------------------------------------------------------------------------

        $this->SetFieldAttr('setorDestino', 'item', 'setor');
        $this->SetFieldAttr('setorDestino', 'related', 'idSetorDestino,setorDestino');
        $this->SetFieldAttr('idSetorDestino', 'related', 'idSetorDestino,idsetor');

        //-----------------------------------------------------------------------------------------------

        $this->SetFieldAttr('instOrigem', 'item', 'instituicao2');
        $this->SetFieldAttr('instOrigem', 'related', 'idInstOrigem, instOrigem');
        $this->SetFieldAttr('idInstOrigem', 'related', 'idInstOrigem, idinstituicao');

        //-----------------------------------------------------------------------------------------------

        $this->SetFieldAttr('instDestino', 'item', 'instituicao2');
        $this->SetFieldAttr('instDestino', 'related', 'idInstDestino, instDestino');
        $this->SetFieldAttr('idInstDestino', 'related', 'idInstDestino, idinstituicao');



        $buttons = array(
            new MButton('btnPost', 'Gerar Relatório'),
        );
        $this->SetButtons($buttons);

        $buttons = array(
            new MButton('btnReset', 'Limpar Campos'),
        );
        $this->SetButtons($buttons);
    }

    public function btnPost_click() {
        global $MIOLO, $module, $item, $theme;
        $tombo = $this->GetFormValue('tombo');
        $setorOrigem = $this->GetFormValue('idSetorOrigem');
        $setorDestino = $this->GetFormValue('idSetorDestino');

        $datainicio = $this->GetFormValue('datainicio');
        $datafim = $this->GetFormValue('datafim');

        $instOrigem = $this->GetFormValue('idInstOrigem');
        $instDestino = $this->GetFormValue('idInstDestino');

        if($instDestino != "" or $instOrigem != "" or $setorDestino != "" or $setorOrigem != "" ){
        if (($instDestino != "" or $instOrigem != "" ) == ($setorDestino != "" or $setorOrigem != "" )) {
            $this->Error("Instituto e Setor selecionados. Favor selecione somente o Instituto ou o Setor.");
            return;
        }
        else{};
        }
//        foreach ($instDestino && $instOrigem && $setorDestino && $setorOrigem as $word) {
//            $cochetes = array('[', ']');
//            $word = str_replace($cochetes, '', $word);
//        }

        $MIOLO->page->AddJsCode('window.open("http://' . $_SERVER['HTTP_HOST'] . '/relatorios2/repItensTransferencia.php?tombo='
                . $tombo . '&setororigem=' . $setorOrigem . '&setordestino=' . $setorDestino . '&datainicio='
                . $datainicio . '&datafim=' . $datafim . '&instOrigem=' . $instOrigem . '&instDestino=' . $instDestino . '");');
//                header("Location: http://".$_SERVER['HTTP_HOST']
//                ."/relatorios2/repItensTransferencia.php?tombo=$tombo
//                &setororigem=$setorOrigem&setordestino=$setorDestino
//                &datainicio=$datainicio&datafim=$datafim&instOrigem=$instOrigem&instDestino=$instDestino");        

        return;
    }

    //criado por DANILO MERÇON
    public function btnReset_click() {
        global $MIOLO;
        $tombo = $this->setFieldValue('tombo', '');
        $setorOrigem = $this->setFieldValue('idSetorOrigem', '');
        $setorDestino = $this->setFieldValue('idSetorDestino', '');
        $setorOrigem = $this->setFieldValue('setorOrigem', '');
        $setorDestino = $this->setFieldValue('setorDestino', '');

        $datainicio = $this->setFieldValue('datainicio', '');
        $datafim = $this->setFieldValue('datafim', '');

        $instOrigem = $this->setFieldValue('idInstOrigem', '');
        $instDestino = $this->setFieldValue('idInstDestino', '');
        $instOrigem = $this->setFieldValue('instOrigem', '');
        $instDestino = $this->setFieldValue('instDestino', '');
    }

}
