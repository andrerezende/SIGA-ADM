<?
class frmInssDados extends MForm
{
	protected $objinss;

	function __construct($objinss)
	{
		$this->objinss = $objinss;
		parent::__construct('Dados da alíquota do INSS');
		$this->EventHandler();
	}

	function CreateFields()
	{
		global $MIOLO;
		$fields = array(
			new MTextField('idInss','','código','5'),
			new MCalendarField('dataIni','','Data de incício','10'),
			new MCalendarField('dataFim','','Data fim','10'),
			new MCurrencyField( 'ate', '', 'Valor Máximo','20'), 
			new MTextField('percentual','','Percentual','6'),
			new MCurrencyField( 'fixo', '', 'Fixo','20'), 
			new MTextField('percPatronal','','Percentual Patronal','6')
		);
		$this->SetFields($fields);

		$this->SetFieldAttr('idInss','readonly',true);

		$buttons = array(
			new MButton('btnSalvar','Salvar'),
		);
		$this->SetButtons($buttons);

		$validators = array(
			new MRequiredValidator('dataIni'),
			new MRequiredValidator('dataFim'),
			new MRequiredValidator('percentual'),
			new MRequiredValidator('percPatronal')
		);
		$this->setValidators($validators);

		$this->SetData();
	}

	function SetData()
	{
		$data = $this->objinss;
		$this->SetFieldValue('idInss',$data->idInss);
		$this->SetFieldValue('dataIni',$data->dataIni);
		$this->SetFieldValue('dataFim',$data->dataFim);
		$this->SetFieldValue('ate',$data->ate);
		$this->SetFieldValue('percentual',$data->percentual);
		$this->SetFieldValue('fixo',$data->fixo);
		$this->SetFieldValue('percPatronal',$data->percPatronal);
	}
	public function btnSalvar_click()
	{
		$this->objinss->SetData($this->GetData());
		$cf = new MCurrencyFormatter();
		$this->objinss->ate = $cf->toDecimal($this->objinss->ate);
		$this->objinss->fixo = $cf->toDecimal($this->objinss->fixo);


		if($this->objinss->dataIni > $this->objinss->dataFim)
		{
			$this->AddError('A data Fim deve ser posterior a Data Início.');
		}
		elseif( Form::GetFormValue('percentual') <= 0 )
		{
			$this->AddError('Informe um percentual válido.');
		}
		elseif( Form::GetFormValue('percPatronal') <= 0 )
		{
			$this->AddError('Informe um percentual patronal válido.');
		}
		else
		{
			try
			{
				$this->objinss->save();
				$this->AddInfo("Dados alterados com sucesso!");
			}
			catch (Exception $e)
			{
				$this->AddError($e->GetMessage);
			}
		}
	}
}
?>
  
	