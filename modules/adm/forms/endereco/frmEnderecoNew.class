

<?php
// 15-12-2011 - Daniel Bonfim

class frmEnderecoNew extends MForm
{
    function __construct() {
        global $MIOLO, $module;

        parent::__construct('Inserir Endereço');
        $this->SetClose($MIOLO->GetActionURL('adm','main:endereco:find'));
        $this->EventHandler();
        $this->defaultButton = false;
        $this->page->addJsCode(file_get_contents(dirname(__FILE__) . '/../../ui/js/mask.js'));
        $this->page->addJsCode(file_get_contents(dirname(__FILE__) . '/../../ui/js/cidades-estados-v0.2.js'));

    }

    function CreateFields() {
        global $MIOLO, $module, $action, $item, $theme, $event;
        $cidades = array();
        
        

        $estados = array(
            'AC' => 'ACRE',
            'AL' => 'ALAGOAS',
            'AP' => 'AMAPÁ',
            'AM' => 'AMAZONAS',
            'BA' => 'BAHIA',
            'CE' => 'CEARÁ',
            'DF' => 'DISTRITO FEDERAL',
            'ES' => 'ESPÍRITO SANTO',
            'GO' => 'GOIÁS',
            'MA' => 'MARANHÃO',
            'MT' => 'MATO GROSSO',
            'MS' => 'MATO GROSSO DO SUL',
            'MG' => 'MINAS GERAIS',
            'PA' => 'PARÁ',
            'PB' => 'PARAÍBA',
            'PR' => 'PARANÁ',
            'PE' => 'PERNAMBUCO',
            'PI' => 'PIAUÍ',
            'RJ' => 'RIO DE JANEIRO',
            'RN' => 'RIO GRANDE DO NORTE',
            'RS' => 'RIO GRANDE DO SUL',
            'RO' => 'RORAIMA',
            'RR' => 'RONDÔNIA',
            'SC' => 'SANTA CATARINA',
            'SP' => 'SÃO PAULO',
            'SE' => 'SERGIPE',
            'TO' => 'TOCANTINS'
            );?>
        <script type="text/javascript" src="http://cidades-estados-js.googlecode.com/files/cidades-estados-v0.2.js"></script>
<script type="text/javascript">
    window.onload = function() {
        new dgCidadesEstados(
            document.getElementById('estado'),
            document.getElementById('cidade'),
            true
        );
    }
</script>

         <?
           $numero_field =new MTextField('numero','','Número',20,'' );
		$numero_field->addAttribute('onKeyUp', 'makeMask(this, \'#################\');');
		$numero_field->addAttribute('maxlength',18);
         $cidades = array();
        $fields = array(
            new MTextField('nomelocal','','Local',50),
            new MTextField('endereco', '', 'Endereço', 50),
            new MTextField('bairro', '', 'Bairro', 30),
            $numero_field,
            //new MTextField('numero', '', 'Número', 20),
            new MTextField('complemento', '', 'Complemento', 50),
            new MTextField('cep', '', 'Cep', 15),

//             new MSelection('estado', '', 'Estado', $estados),
//             new MTextField('cidade', '', 'Cidades',$cidades ),


            new MSelection('estado', '', 'Estado', $estados),
            new MSelection('cidade', '', 'Cidade',$cidades)
              
        );

        $this->SetFields($fields);
 //Javascript para select de cidades

        $this->page->addJsCode('

window.onload = function() {
        new dgCidadesEstados(
            document.getElementById("estado"),
            document.getElementById("cidade"),
            true
        )
    };  ');



        //$this->SetFieldAttr('tfNumeroEmpenho', 'readonly', true);

        // Atributos dos campos

        $this->cep->addAttribute('maxlength',9);
        $this->cep->addAttribute('onKeyUp', 'makeMask(this, \'#####-###\');');
	$this->cep->addAttribute('onBlur', 'makeMask(this, \'#####-###\');');

        $go = $this->manager->getActionURL('adm','endereco:find');
        $buttons = array(
            new MButton('btnNew', 'Salvar'),
            new MButton('btnRetornar', 'Retornar', $go)
        );
        $this->SetButtons($buttons);

    }



    function btnNew_click() {
        global $MIOLO, $module, $action, $item, $theme;
        $session = $MIOLO->getSession();
        $idUo = $session->getValue('listaIdUo');

        // Tratamento de Erros
               
            if (!trim($this->GetFormValue('nomelocal'))) {
                $this->addError("Insira o Local");
            }
            if (!trim($this->GetFormValue('cidade'))) {
                $this->addError("Insira a cidade");
            }
            if (!trim($this->GetFormValue('estado'))) {
                $this->addError("Selecione o estado");
            }
            if (!trim($this->GetFormValue('cep'))) {
                $this->addError("Insira o cep");
            }
            if (!trim($this->GetFormValue('endereco'))) {
                $this->addError("Insira o endereco");
            }
            if (!trim($this->GetFormValue('bairro'))) {
                $this->addError("Insira o bairro");
            }
    //		Caso haja algum erro, exibe na tela.
            if ($this->errors != '') {
                    $this->GenerateErrors();
            } else {

                $data = $this->GetData();

                $endereco = $MIOLO->GetBusiness('adm', 'endereco');

                $endereco->idEndereco = $endereco->getNextId();
                $endereco->bairro = trim($data->bairro);
                $endereco->endereco = trim($data->endereco);
                $endereco->numero = trim($data->numero);
                $endereco->complemento = trim($data->complemento);
                $endereco->cep = str_replace("-","",trim($data->cep));
                $endereco->cidade = trim($data->cidade);
                $endereco->estado = trim($data->estado);
                 $endereco->nomelocal = trim($data->nomelocal);
                 $endereco->iduo = $idUo;

                try {
                    $endereco->save();

                    $go = $this->manager->GetActionURL('adm','main:endereco:find');
                    $MIOLO->Information("Cadastro realizado com sucesso.", $go);

                } catch (Exception $e) {

                    $this->AddInfo("Falha ao inserir endereço.".$e);
                }

            }
    }



}


?>