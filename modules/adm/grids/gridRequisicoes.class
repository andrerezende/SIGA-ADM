<?
/**
 * Grid Uo
 * Grid de uso geral para selecionar requisicoes
 * @package br.org.miolo.ufjf.adm.grids
 */
/**
 * Use Module Control
 */
global $MIOLO;
$MIOLO->Uses('controls/linkrequisicao.class','adm');

class gridRequisicoes extends DataGrid2
{

    /**
     * Constructor
     */
    function __construct()
    { 
        global $MIOLO, $self, $page, $item;
        
        $linkRequisicao = new LinkRequisicao('linkrequisicao','%0%');
        $idUsuario = $MIOLO->GetLogin()->idkey;
	$uo = $MIOLO->GetBusiness('adm','uo');
        $objTipoReq = $MIOLO->GetBusiness('adm','tiporeq');
        $objGestor= $MIOLO->GetBusiness('adm','gestor');
        $objExecutor= $MIOLO->GetBusiness('adm','executor');
        $objTipoReq->GetById((int)$item);
        $uoRequisitante = $uo->listByUsuarioTipoReqAlm($idUsuario,$objTipoReq->idTipoReq);
        $optionsUo3 = $uoRequisitante->chunkResult();
        
        $cont = count($uoRequisitante->result);
        
        //$lista_iduo = array();
        
        for($i = 0;$i < $cont;$i++){
           $idUo =  $uoRequisitante->result[$i][0];
           $tam++;
           if($tam == $cont)
           $lista_iduo .= $idUo;
           else
               $lista_iduo .= $idUo . ",";
        }
       
		$idUoGestor = Form::GetFormValue('idUoGestor');
		$idUoExecutor = Form::GetFormValue('idUoExecutor');
                $idUoRequisitante = Form::GetFormValue('idUoRequisitante');
	        $filter = Form::GetFormValue('requisicao');
                $dataInicio = Form::GetFormValue('datainicio');
                $dataSaida = Form::GetFormValue('datasaida');

        $opcao = Form::GetFormValue('opcao');
        $opcao2 = Form::GetFormValue('opcao2');
        $opcao3 = Form::GetFormValue('opcao3');
        
        $btnPost = Form::GetFormValue('btnPost');
        $btnPost2 = Form::GetFormValue('btnPost2');
        $btnPost3 = Form::GetFormValue('btnPost3');

        $idUsuario = $MIOLO->GetLogin()->idkey;
        
        if ( $btnPost3 && $opcao3 ) //Opções do Requisitante
        {       
                    
            if($dataInicio && $dataSaida){
               $dataInicio = $this->formataData($dataInicio);
               $dataSaida = $this->formataData($dataSaida);
            }
         	$objRequisicao = $MIOLO->GetBusiness('adm','requisicao');
        	$columns = array(
            	new DataGridControl($linkRequisicao,'requisicao','Número','left', true,'10%'),
            	new DataGridColumn('dataHora','Data/Hora','left', true,'15%'),
                new MDataGridColumn('login','Login','center',false,'20%'),
                new MDataGridColumn('sigla','Setor','center',false,'20%'),
            	//new DataGridColumn('sigla','Unidade Orçamentária','center', true,'30%'),
                new DataGridColumn('status','Status','center',false,'35%)%'),
                    //new DataGridColumn('tiporequisicao','Origem','center', true,'30%'),
                    
    		     );
        	$this->SetFilter(false);
        	$this->AddFilterText('requisicao','Requisição',$uo);
	        $this->SetIndex(1);

    		//$query = $objRequisicao->ListByStatusUsuario($opcao3,$idUsuario);
                if($idUoRequisitante){
                    $query = $objRequisicao->ListByStatusUsuarioAlmoxarifado($opcao3,$idUsuario,$idUoRequisitante,$dataInicio,$dataSaida );
                }else{
                    $query = $objRequisicao->listAlmoxarifadoUsuarioUoStatus($opcao3,$lista_iduo);
                }
           
    		
		    //$href_grid = $MIOLO->GetActionURL('adm',$self,'',array("opcaoGestor"=>$opcaoGestor,"idUoGestor"=>$idUoGestor,"idUoExecutor"=>$idUoExecutor,"requisicao"=>$filter,"opcao"=>$opcao,"opcao2"=>$opcao2,"opcao3"=>$opcao3,"btnPost"=>$btnPost,"btnPost2"=>$btnPost2,"btnPost3"=>$btnPost3));
                $href_grid = $MIOLO->GetActionURL('adm',$self,$item);
    	}
    	elseif ($idUoRequisitante & !$dataInicio && !$dataSaida ) {
                $objRequisicao = $MIOLO->GetBusiness('adm','requisicao');
        	$columns = array(
            	new DataGridControl($linkRequisicao,'requisicao','Número','left', true,'10%'),
            	new DataGridColumn('dataHora','Data/Hora','left', true,'15%'),
                new MDataGridColumn('login','Login','center',false,'20%'),
                new MDataGridColumn('sigla','Setor','center',false,'20%'),
            	//new DataGridColumn('sigla','Unidade Orçamentária','center', true,'30%'),
                new DataGridColumn('status','Status','center',false,'35%)%'),
                    //new DataGridColumn('tiporequisicao','Origem','center', true,'30%'),
                    
    		     );
        	$this->SetFilter(false);
        	$this->AddFilterText('requisicao','Requisição',$uo);
	        $this->SetIndex(1);
                    $query = $objRequisicao->listAlmoxarifadoUo($idUoRequisitante);
                    $href_grid = $MIOLO->GetActionURL('adm',$self,$item);
        }elseif ($dataInicio && $dataSaida && (!$opcao3)) {
            if($dataInicio && $dataSaida){
                $objRequisicao = $MIOLO->GetBusiness('adm','requisicao');
        	$columns = array(
            	new DataGridControl($linkRequisicao,'requisicao','Número','left', true,'10%'),
            	new DataGridColumn('dataHora','Data/Hora','left', true,'15%'),
                new MDataGridColumn('login','Login','center',false,'20%'),
                new MDataGridColumn('sigla','Setor','center',false,'20%'),
            	//new DataGridColumn('sigla','Unidade Orçamentária','center', true,'30%'),
                new DataGridColumn('status','Status','center',false,'35%)%'),
                    //new DataGridColumn('tiporequisicao','Origem','center', true,'30%'),
                    
    		     );
        	$this->SetFilter(false);
        	$this->AddFilterText('requisicao','Requisição',$uo);
	        $this->SetIndex(1);
                    $dataInicio = $this->formataData($dataInicio);
                    $dataSaida = $this->formataData($dataSaida);
                    //$query = $objRequisicao->listReqAlmoxarifadoData($dataInicio,$dataSaida);
                    $query = $objRequisicao->listUsuarioAlmoxarifado($lista_iduo,$dataInicio,$dataSaida);
                    //$query = $objRequisicao->ListByStatusUsuarioAlmoxarifado($opcao3,$idUsuario,$idUoRequisitante,$dataInicio,$dataSaida );
            // $href_grid = $MIOLO->GetActionURL('adm',$self,'',array("opcaoGestor"=>$opcaoGestor,"idUoGestor"=>$idUoGestor,"idUoExecutor"=>$idUoExecutor,"requisicao"=>$filter,"opcao"=>$opcao,"opcao2"=>$opcao2,"opcao3"=>$opcao3,"btnPost"=>$btnPost,"btnPost2"=>$btnPost2,"btnPost3"=>$btnPost3));
                    $href_grid = $MIOLO->GetActionURL('adm',$self,$item);
              }else{
                  $MIOLO->Error("Preencha todas as tadas corretamente!");
              }
        }
        else{
        	$objRequisicao = $MIOLO->GetBusiness('adm','requisicao');
        	$columns = array(
			new MDataGridControl($linkRequisicao,'requisicao','Número','center','10%'),
			new MDataGridColumn('datahorareq','Data/Hora','center',false,'25%'),
			new MDataGridColumn('login','Login','center',false,'20%'),
			new MDataGridColumn('siglasetor','Setor','center',false,'20%'),
			new MDataGridColumn('item2','Status','center',false,'25%)%'),
			//new MDataGridColumn('descricao','Origem','center',false,'20%'),
		);
        	$this->SetFilter(false);
    		$requisicao = empty($filter) ? 0 : $filter;

        	$this->AddFilterText('requisicao','Requisição',$uo);
	        $this->SetIndex(1);

     		$executor = $MIOLO->GetBusiness('adm','executor');
	    	$uoExec = $executor->listUoByUsuario($idUsuario);




		if((!is_numeric($requisicao)) and (!empty($requisicao)))
		{
			if($requisicao=='%')
				$requisicao=0;
			else
			{
				$go = $MIOLO->GetActionURL($module,$action);
				$MIOLO->Error('Digite o "número" da requisição ou "%" para listar todas', $go );
			}
		}
                $gestorTeste = $objGestor->isUsuarioGestorUo($idUsuario,$item);
                $executorTeste = $objExecutor->isUsuarioExecutorUo($idUsuario,$item);
            //if($lista_iduo){    

            // Se o usuário for executor de pelo menos uma UO então ele poder ver qualquer requisicao.
            if ($uoExec->result)
            {
	    	    //$query = $objRequisicao->ListByNumeroUsuario2($requisicao);
                $query = $objRequisicao->ListByNumeroUsuario2Almoxarifado($requisicao,$lista_iduo);
            }
            else
            {
		
	    	    //$query = $objRequisicao->ListByNumeroUsuario($requisicao, $idUsuario);
                $query = $objRequisicao->ListByNumeroUsuarioAlmoxarifado($requisicao, $idUsuario,$lista_iduo);
		  
            }
           /* }else{
                
                if($gestorTeste && (!$executorTeste)){
                    $query = $objRequisicao->listReqAlmoxarifadoGestor($requisicao, $idUsuario);
                }else if($executorTeste && (!$gestorTeste)){
                    
                    $uoexecutor = $objExecutor->listReqUoAlmoxarifadoExecutor($idUsuario);
                    
                    $cont = count($uoexecutor->result);
                    for($i = 0;$i < $cont;$i++){
                        $idUo =  $uoexecutor->result[$i][0];
                        $tam++;
                        if($tam == $cont)
                           $lista_iduoexe .= $idUo;
                        else
                        $lista_iduoexe .= $idUo . ",";
                     }
                     $query = $objRequisicao->ListByNumeroUsuario2Almoxarifado($requisicao,$lista_iduoexe);
                    
                }else if($executorTeste && $gestorTeste){
                    $uogestor = $objGestor->listReqUoAlmoxarifadoGestor($idUsuario);
                    $uoexecutor = $objExecutor->listReqUoAlmoxarifadoExecutor($idUsuario);
                    //var_dump($uogestor); var_dump($uoexecutor);exit;
                    $contG = count($uogestor->result);
                    $contE = count($uoexecutor->result);
                    for($i = 0;$i < $contG;$i++){
                        $idUo =  $uogestor->result[$i][0];
                     
                        $lista_iduoexe .= $idUo . ",";
                     }
                     
                     for($i = 0;$i < $contE;$i++){
                        $idUo =  $uoexecutor->result[$i][0];
                        $tam++;
                        if($tam == $contE)
                           $lista_iduoexe .= $idUo;
                        else
                        $lista_iduoexe .= $idUo . ",";
                     }
                    //if($lista_iduoexe){
                     $query = $objRequisicao->ListByNumeroUsuario2Almoxarifado($requisicao,$lista_iduoexe);
                   
                }else{
                    $go = $MIOLO->GetActionURL('adm', 'main');
		    $MIOLO->Error('Entre em contato com o administrador do sistema', $go );
                }
                
            }*/


		    //$href_grid = $MIOLO->GetActionURL('adm',$self,'',array("opcaoGestor"=>$opcaoGestor,"idUoGestor"=>$idUoGestor,"idUoExecutor"=>$idUoExecutor,"requisicao"=>$filter,"opcao"=>$opcao,"opcao2"=>$opcao2,"opcao3"=>$opcao3,"btnPost"=>$btnPost,"btnPost2"=>$btnPost2,"btnPost3"=>$btnPost3));
            $href_grid = $MIOLO->GetActionURL('adm',$self,$item);
	    }
        parent::__construct($query, $columns, $href_grid,100);
        $this->SetLinkType('hyperlink');
    }

    function GenerateFooter()
    {
        if (!$this->data) 
        $footer[] = $this->GenerateEmptyMsg();
        $footer[] = new Separator();
        $footer[] = $this->GenerateControls();
        return $footer;
    }
    
    public function formataData($dataInicio){
        $arrData = explode('/', $dataInicio);
        $newDate = $arrData [2].'-'.$arrData [1].'-'.$arrData [0];
        return $newDate;
    }

}

