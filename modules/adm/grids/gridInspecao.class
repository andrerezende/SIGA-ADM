<?
/**
 * Grid Uo
 * Grid de uso geral para selecionar requisicoes
 * @package br.org.miolo.ufjf.adm.grids
 */
/**
 * Use Module Control
 */
global $MIOLO;
$MIOLO->Uses('controls/linkinspecao.class','adm');

class gridInspecao extends DataGrid2
{

    /**
     * Constructor
     */
    function __construct()
    {
        global $MIOLO, $self, $page;
        $session = $MIOLO->getSession();
	$sidUo = $session->get('idUo');
        
        $linkInspecao = new LinkInspecao('linkinspecao','%0%',$sidUo);
        
        $idVeiculor = Form::GetFormValue('veiculo');
        $idMotorista = Form::GetFormValue('motorista');
        $idSituacao = Form::GetFormValue('situacao');
        $dataInicio = Form::GetFormValue('datainicio');
        $dataSaida = Form::GetFormValue('datasaida');
        
        $btnPost1 = Form::GetFormValue('btnPost1');
        $btnPost2 = Form::GetFormValue('btnPost2');
        $btnPost3 = Form::GetFormValue('btnPost3');
        $btnPost4 = Form::GetFormValue('btnPost4');

        $idUsuario = $MIOLO->GetLogin()->idkey;
                $objInspecao = $MIOLO->GetBusiness('adm','inspecao');
        	$columns = array(
			new MDataGridControl($linkInspecao,'id_inspecao','Inspeção','center','5%'),
                        new MDataGridColumn('modelo','Veículo','center',false,'25%'),
                        new MDataGridColumn('nome','Motorista','center',false,'25%'),
			new MDataGridColumn('datainicio','Data/Hora Início','center',false,'20%'),
			new MDataGridColumn('datafim','Data/Hora Fim','center',false,'20%'),
			new MDataGridColumn('ds_situacao_inspecao','Situação','center',false,'10%)%'),
		);
                
                //modelo, nome, ts_inspecao_inicio, ts_inspecao_fim, ds_situacao_inspecao
        	$this->SetFilter(false);
    		$requisicao = empty($filter) ? 0 : $filter;
                $queryInt = $objInspecao->getAllInspecoes();

        	$this->AddFilterText('requisicao','Requisição',$uo);
	        $this->SetIndex(1);

     		$executor = $MIOLO->GetBusiness('adm','executor');
	    	$uoExec = $executor->listUoByUsuario($idUsuario);
                  
                if($btnPost1){
                    $queryInt = $objInspecao->listPorVeiculo($idVeiculor);
                    parent::__construct($queryInt, $columns, $href_grid,100);
                }elseif ($btnPost2) {
                    $dataInicio = $this->formataData($dataInicio);
                    $dataSaida = $this->formataData($dataSaida);
                    $queryInt = $objInspecao->listPorDataIntervalo($dataInicio,$dataSaida);
                    parent::__construct($queryInt, $columns, $href_grid,100);
                }elseif ($btnPost3) 
    	        {
                    $queryInt = $objInspecao->listPorMotorista($idMotorista);
                    parent::__construct($queryInt, $columns, $href_grid,100);
                }
                elseif ($btnPost4) 
    	        {
                    $queryInt = $objInspecao->listPorSituacao($idSituacao);
                    parent::__construct($queryInt, $columns, $href_grid,100);
                }else parent::__construct($queryInt, $columns, $href_grid,100);


		    //$href_grid = $MIOLO->GetActionURL('adm',$self,'',array("opcaoGestor"=>$opcaoGestor,"idUoGestor"=>$idUoGestor,"idUoExecutor"=>$idUoExecutor,"requisicao"=>$filter,"opcao"=>$opcao,"opcao2"=>$opcao2,"opcao3"=>$opcao3,"btnPost"=>$btnPost,"btnPost2"=>$btnPost2,"btnPost3"=>$btnPost3));

        
        $this->SetLinkType('hyperlink');
    }

    function GenerateFooter()
    {
        if (!$this->data) 
        $footer[] = $this->GenerateEmptyMsg();
        $footer[] = new Separator();
        $footer[] = $this->GenerateControls();
        return $footer;
    }
    
    public function formataData($dataInicio){
        $arrData = explode('/', $dataInicio);
        $newDate = $arrData [2].'-'.$arrData [1].'-'.$arrData [0];
        return $newDate;
    }

}

