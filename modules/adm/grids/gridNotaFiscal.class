<?php
global $MIOLO;
$MIOLO->Uses('controls/linknotafiscal.class','adm');
//MIOLO::Import('modules::adm::controls::linknotafiscal');

class gridNotaFiscal extends MDataGrid2 {
	/**
	 * Business utilizado
	 * @var BusinessAdmNotaFiscal
	 */
	public $nota;
	public $perms;

	public function  __construct() {
		global $MIOLO, $module, $page, $context, $self, $action, $perms, $state;

		$this->nota = $MIOLO->GetBusiness($module, 'notafiscal');
		// pega os campos do form para fazer a query
        
		$query = $this->nota->listNotas(
			MForm::GetFormValue('notaFiscal'),
			MForm::GetFormValue('dataNotaFiscal'),
			MForm::GetFormValue('valor'),
			MForm::GetFormValue('dataAteste')
		);
                //var_dump($query);exit;    
		$this->SetIndex(1);

		$objNotaFiscal = $MIOLO->GetBusiness($module, 'notafiscal');

		$linkNotaFiscal = new LinkNotaFiscal('linknotafiscal','%0%');
//		$hrefNotaFiscal = $MIOLO->getActionURL('adm','main:notafiscal:edit','#0#' );
//		$hrefNotaFiscal = $MIOLO->getActionURL('adm','main:notafiscal','#0#' );

//		$MIOLO->Dump($linkNotaFiscal, true, true, true);exit;

		$columns = array(
			new MDataGridColumn('idnotafiscal','ID','center',true,'7%'),
//			new MDataGridHyperlink('notaFiscal','Nota Fiscal', $hrefNotaFiscal,'35%',true,null,true),
			new DataGridControl($linkNotaFiscal, 'notafiscal','Nota Fiscal','left',false,'35%'),
//			new MDataGridColumn('notaFiscal','Nota Fiscal','',false,'30%'),
			new MDataGridColumn('datanotafiscal','Data de emissão','right',true,'20%'),
			new MDataGridColumn('valor','Valor','right',true,'25%',true,null,true),
			new MDataGridColumn('dataAteste','Data do Ateste','right',true,'20%')
		);

		$notafiscal= MForm::GetFormValue('notaFiscal');
		$datanotafiscal= MForm::GetFormValue('dataNotaFiscal');
		$valor= MForm::GetFormValue('valor');
		$dataateste= MForm::GetFormValue('dataAteste');
		$tomboanterior=MForm::GetFormValue('tomboanterior');
		$empenho=MForm::GetFormValue('empenho');
		$cnpj=MForm::GetFormValue('cnpj');
		$numeroserie=MForm::GetFormValue('numeroserie');

		if ($cnpj) {
                    $cnpj = str_replace('.', '', $cnpj);
                    $cnpj = str_replace('-', '', $cnpj);
                    $cnpj = str_replace('/', '', $cnpj);
			if (!is_numeric($cnpj)) {
				$this->addError("Insira apenas números no campo CNPJ");
			}
		}

		$campos = array(
			$idnotafiscal,     //0
			$notafiscal,        //1
			$datanotafiscal, //2
			$valor,               //3
			$dataateste,      //4
			$tomboanterior,//5
			$empenho,	//6
			$cnpj,		//7
			$numeroserie,	//8
			$situacao,		//9
		);
		$contador=0;
			for($i=0;$i<8;$i++){
				if($campos[$i]!=""){
					$contador++;
				}
			}

			if($contador==0){
				$validador=1;
			}


			else{
				$validador=0;
				$this->SetTitle(NULL);
			}
			
                //$teste = 
                //var_dump($objNotaFiscal->Filtrar($campos, $validador));exit;

		// referencia a ele proprio
		$href_grid = $MIOLO->GetActionURL('adm', $self);
		parent::__construct($objNotaFiscal->Filtrar($campos, $validador), $columns, $href_grid, 25);
		$this->SetWidth('85%');
		$this->SetClose(null);
//		$this->SetLinkType('hyperlink');
	}
}
