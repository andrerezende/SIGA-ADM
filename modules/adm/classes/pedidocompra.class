<?php
class BusinessAdmPedidoCompra extends Business {

	public $idPedidoCompra;
	public $idUsuario;
	public $idSetor;
	public $idMaterial;
	public $idServico;
	public $instituicao;
	public $data;
	public $numPro;
	public $situacao;
	public $quantidade;
	public $empresa1;
	public $empresa1Cnpj;
	public $empresa1Cotacao;
	public $empresa2;
	public $empresa2Cnpj;
	public $empresa2Cotacao;
	public $empresa3;
	public $empresa3Cnpj;
	public $empresa3Cotacao;
	public $fundamentacao;
	public $justificativa;
	public $objeto;

	public function __construct($database = NULL, $data = NULL) {
		parent::__construct('sigaept', $data);
	}

	public function GetById($idPedidoCompra) {
		$this->idPedidoCompra = $idPedidoCompra;
		$this->retrieve();
		return $this;
	}

	public function OnCreate($data) {
		if (!empty($data)) {
			$this->GetById($data);
		}
	}

	public function listPedidos($situacao = null, $instituicao = null, $processo = null, $data = null, $cadmat = null, $codservico = null, $natureza = null) {
		/**
		 * @var sql
		 */
		$sql;
		$sql = new sql(
						"p.idpedidocompra as pedido, p.situacao,TO_CHAR(p.data,'DD/MM/YYYY') as data, i.instituicao as instituicao, s.siglasetor as setor, u.nick as usuario",
						"ad_pedidocompra p, cm_setor s, cm_usuario u, cm_instituicao i",
						"p.idsetor = s.idsetor AND p.idusuario = u.idusuario AND p.idsetor = s.idsetor AND p.instituicao = i.uasg AND i.status = 'A'"
		);
//		', ad_material m, ad_servico sr'
//		' OR p.idmaterial = m.idmaterial OR p.idservico = sr.idservico'
		if (!empty($situacao) && !is_null($situacao)) {
			$sql->SetWhere("p.situacao = UPPER('$situacao')");
		}
		if (!empty($instituicao) && !is_null($instituicao)) {
			$sql->SetWhere("p.instituicao = '$instituicao'");
		}
		if (!empty($processo) && !is_null($processo)) {
			$sql->SetWhere("p.numpro = '$processo'");
		}
		if (!empty($data) && !is_null($data)) {
			$sql->SetWhere("TO_CHAR(p.data,'DD/MM/YYYY') <= TO_CHAR(CAST('$data' as date),'DD/MM/YYYY')");
		}
		if (!empty($cadmat) && !is_null($cadmat)) {
			$sql->SetWhere("p.idmaterial = '$cadmat'");
		}
		if (!empty($codservico) && !is_null($codservico)) {
			$sql->SetWhere("p.idservico = '$codservico'");
		}
//		if ((!empty($natureza[0]) && !is_null($natureza[0])) && (!empty($natureza[1]) && !is_null($natureza[1]))) {
//			$sql->SetWhere("m.idelemento = " .$natureza[0] . " OR m.idsubelemento = " .$natureza[1]);
//		}
		$sql->SetOrderBy("p.idpedidocompra desc");
		$query = $this->Query($sql);
		return $query;
	}
}