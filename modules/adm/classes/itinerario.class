<?

class BusinessAdmItinerario extends Business {

		public $idRequisicao;
		public $ordem;
		public $datasaida;
		public $idEnderecoOrigem;
		public $idEnderecoDestino;

		function __construct($data = null) {
				parent::__construct('sigaept', $data);
		}



		function GetByRequisicao($idRequisicao) {
				$this->idRequisicao = $idRequisicao;
				$this->retrieve();
				return $this;
		}

		function GetByRequisicaoOrdem($idRequisicao,$ordem) {

				$this->idRequisicao = $idRequisicao;
				$this->ordem=$ordem;
				$this->retrieve();
				return $this;
		}

		function GetByIDRequisicao($idRequisicao) {
				$idRequisicao = (int) $idRequisicao;

				$query.= "
						r.idRequisicao,
										r.ordem,
						e.nomelocal as origem,
						e2.nomelocal as destino,

						to_char(r.datasaida, 'DD/MM/YYYY') as datasaida,
						to_char(r.datasaida, 'HH24:MI') as horasaida


						FROM ad_itinerario r
						INNER JOIN ad_endereco e
						ON r.idenderecoorigem=e.idendereco
						INNER JOIN ad_endereco e2
						ON r.idenderecodestino=e2.idendereco
						WHERE r.idrequisicao=$idRequisicao
										ORDER BY ordem

            "

				;
				//$query.=" where idrequisicao= $idRequisicao ";
				$sql = new sql($query);

				$query2 = $this->Query($sql);
				//var_dump($query2->result);exit;

				return $query2;
		}

		function GetNovaOrdem() {
				$idRequisicao = $this->idRequisicao;

				$arrayOrdens=$this->getOrdensByRequisicao($idRequisicao);

				$maior=0;
				for ($index = 0; $index < count($arrayOrdens); $index++) {
						var_dump($arrayOrdens[$index][0]);
						if($arrayOrdens[$index][0]>$maior){
								$maior=$arrayOrdens[$index][0];
						}
				}

				return ($maior+1);
		}

		function GetByIDRequisicao2($idRequisicao) {
				$criteria = $this->getCriteria();
				$criteria->addColumnAttribute('idrequisicao');
				$criteria->addColumnAttribute('idenderecoorigem');
				$criteria->addColumnAttribute('idenderecodestino');
				$criteria->addColumnAttribute('datasaida');

				$criteria->addCriteria('idrequisicao', '=', "$idRequisicao");
				return $criteria->retrieveAsQuery();
		}

		function GetTotalItinerarioByRequisicao($idRequisicao) {
				$query.= "
						count(*) from ad_itinerario where idRequisicao=$idRequisicao
				";
				$sql = new sql($query);
				$query2 = $this->Query($sql);
				return $query2->result[0][0];
		}
		function getOrdensByRequisicao($idRequisicao){
				$query.= "
						ordem from ad_itinerario where idRequisicao=$idRequisicao
				";
				$sql = new sql($query);
				$query2 = $this->Query($sql);
				return $query2->result;
		}
		function updateOrdem($ordem){
		$sql = new sql();
        $sql->SetColumns('
                ordem
        ');
        $sql->SetTables('ad_itinerario');
        $sql->SetWhere('idRequisicao = '.$this->idRequisicao);
        $sql->SetWhereAnd('ordem='.$this->ordem);
		$values = array($ordem);
		$this->Execute($sql->Update($values));

		}

}