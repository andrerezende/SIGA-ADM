<?
class BusinessAdmInspecao extends Business
{
	public $idInspecao;
	public $idVeiculo;
	public $idMotorista;
        public $idSituacaoInspecao;
        public $motorista;
        public $veiculo;
        public $dataHoraInicio;
        public $dataHoraFim;
        public $confirmacao;
        public $confirmacaofinal;

	function __construct($data = null)
	{
		parent::__construct('sigaept', $data);
	}

    function OnCreate($data)
    {
        if (empty($data))
        {

        }
        else
        {
            $this->GetById($data);
        }
    }

	function GetById($id)
	{
		$this->idInspecao = $id;
		$this->retrieve();
		return $this;
	}

	function ListAll()
	{
        $criteria =  $this->getCriteria();
        return $criteria->retrieveAsQuery();
	}

	function ListByPlaca($idInspecao)
	{
        $criteria =  $this->getCriteria();
        $criteria->addCriteria('idinspecao','=', "$idInspecao");
        $criteria->addOrderAttribute('idinspecao');
        return $criteria->retrieveAsQuery();
	}
        function ListAllInspecoes(){
        $sql = new sql('modelo, nome, ts_inspecao_inicio, ts_inspecao_fim, ds_situacao_inspecao','');
        $sql->SetJoin('vei_inspecao i, ad_motorista m, cm_pessoa p, ad_veiculo v, vei_situacao_inspecao s','i.id_motorista = m.idmotorista, m.idpessoa = p.idpessoa, v.placa = i.id_veiculo, i.id_situacao_inspecao = s.id_situacao_inspecao');
        $sql->SetOrderBy('ts_inspecao_inicio');
        return $this->Query($sql);
        }
        
        function getAllInspecoes(){ 

		$query.= "id_inspecao, modelo, nome, TO_CHAR(ts_inspecao_inicio, 'DD/MM/YY HH:MM:SS') as datainicio, TO_CHAR(ts_inspecao_fim, 'DD/MM/YY HH:MM:SS') as datafim, ds_situacao_inspecao
				FROM vei_inspecao i inner join ad_motorista m on i.id_motorista = m.idmotorista
				inner join cm_pessoa p on m.idpessoa = p.idpessoa inner join ad_veiculo v
                                on v.placa = i.id_veiculo inner join vei_situacao_inspecao s
                                on i.id_situacao_inspecao = s.id_situacao_inspecao
                                ORDER BY id_inspecao DESC
				"

				;
		$sql = new sql($query);
                $query2 = $this->Query($sql);
                return $query2;
	}
        
        public function setStatus($id){
            $this->idSituacaoInspecao =  $id;
        }
        public  function getItem($opcao,$idObjeto){
            global $MIOLO;

            switch ($opcao)
            {
                case 1:
                  $this->veiculo =  $MIOLO->GetBusiness('adm','veiculo');
                return $this->veiculo->GetById($idObjeto);

                case 2:
                    $this->motorista = $MIOLO->GetBusiness('adm','motorista');
                return $this->motorista->GetById($idObjeto);             

            }
        }
        
        public function listPorVeiculo($placa){ 
                $placa = strtoupper($placa);

		$query.= "id_inspecao, modelo, nome, TO_CHAR(ts_inspecao_inicio, 'DD/MM/YY HH:MM:SS') as datainicio, TO_CHAR(ts_inspecao_fim, 'DD/MM/YY HH:MM:SS') as datafim, ds_situacao_inspecao
				FROM vei_inspecao i inner join ad_motorista m on i.id_motorista = m.idmotorista
				inner join cm_pessoa p on m.idpessoa = p.idpessoa inner join ad_veiculo v
                                on v.placa = i.id_veiculo inner join vei_situacao_inspecao s
                                on i.id_situacao_inspecao = s.id_situacao_inspecao
                                where i.id_veiculo like upper('%$placa%')
                                ORDER BY id_inspecao DESC
				"

				;
		$sql = new sql($query);
                $query2 = $this->Query($sql);
                return $query2;
        }
        
        public function listPorMotorista($idMotorista){
            $query.= "id_inspecao, modelo, nome, TO_CHAR(ts_inspecao_inicio, 'DD/MM/YY HH:MM:SS') as datainicio, TO_CHAR(ts_inspecao_fim, 'DD/MM/YY HH:MM:SS') as datafim, ds_situacao_inspecao
				FROM vei_inspecao i inner join ad_motorista m on i.id_motorista = m.idmotorista
				inner join cm_pessoa p on m.idpessoa = p.idpessoa inner join ad_veiculo v
                                on v.placa = i.id_veiculo inner join vei_situacao_inspecao s
                                on i.id_situacao_inspecao = s.id_situacao_inspecao
                                where i.id_motorista = $idMotorista
                                ORDER BY id_inspecao DESC
				"

				;
		$sql = new sql($query);
                $query2 = $this->Query($sql);
                return $query2;
        }
        
        public function listPorDataIntervalo($dataInicio, $dataFim){
            $query.= "id_inspecao, modelo, nome, TO_CHAR(ts_inspecao_inicio, 'DD/MM/YY HH:MM:SS') as datainicio, 
                                TO_CHAR(ts_inspecao_fim, 'DD/MM/YY HH:MM:SS') as datafim, ds_situacao_inspecao
				FROM vei_inspecao i inner join ad_motorista m on i.id_motorista = m.idmotorista
				inner join cm_pessoa p on m.idpessoa = p.idpessoa inner join ad_veiculo v
                                on v.placa = i.id_veiculo inner join vei_situacao_inspecao s
                                on i.id_situacao_inspecao = s.id_situacao_inspecao
                                where ts_inspecao_inicio between '$dataInicio' and '$dataFim'
                                ORDER BY id_inspecao DESC
				"

				;
		$sql = new sql($query);
                $query2 = $this->Query($sql);
                return $query2;
        }
        
        public function listPorSituacao($idSituacao){
            $query.= "id_inspecao, modelo, nome, TO_CHAR(ts_inspecao_inicio, 'DD/MM/YY HH:MM:SS') as datainicio, TO_CHAR(ts_inspecao_fim, 'DD/MM/YY HH:MM:SS') as datafim, ds_situacao_inspecao
				FROM vei_inspecao i inner join ad_motorista m on i.id_motorista = m.idmotorista
				inner join cm_pessoa p on m.idpessoa = p.idpessoa inner join ad_veiculo v
                                on v.placa = i.id_veiculo inner join vei_situacao_inspecao s
                                on i.id_situacao_inspecao = s.id_situacao_inspecao
                                where i.id_situacao_inspecao = $idSituacao
                                ORDER BY id_inspecao DESC
				"

				;
		$sql = new sql($query);
                $query2 = $this->Query($sql);
                return $query2;
        }
        
        public function ultimaInspecaoInicio($placa){
           $query.= "MAX(ts_inspecao_inicio) AS ultima from vei_inspecao_componente ic 
                     inner join vei_inspecao i on i.id_inspecao = ic.id_inspecao
                     where id_situacao_inspecao = 3 and id_veiculo = '$placa'";
		$sql = new sql($query);
                $query2 = $this->Query($sql);
                return $query2; 
        }
        
        public function ultimaInspecaoFim($placa){
           $query.= "MAX(ts_inspecao_fim) AS ultima
	        from vei_inspecao_componente ic
                inner join vei_inspecao i on i.id_inspecao = ic.id_inspecao
                where id_situacao_inspecao = 3 and id_veiculo = '$placa'";
		$sql = new sql($query);
                $query2 = $this->Query($sql);
                return $query2; 
        }
        
        public function comparaUltima($placa){
            
            $data1 = $this->ultimaInspecaoFim($placa);
            $data2 =  $this->ultimaInspecaoInicio($placa);
            
            if($data1->result[0][0] > $data2->result[0][0]){
              $data = $data1->result[0][0]; 
            }else{
              $data = $data2->result[0][0];  
            }
            
            $idInspecao = $this->getUltimaInspecao($placa,$data);
            
            return $idInspecao; 
        }
        
        public function getUltimaInspecao($placa,$data){
             $query.= "i.id_inspecao
	        FROM vei_inspecao i inner join vei_inspecao_componente ic on ic.id_inspecao = i.id_inspecao
                where id_veiculo = '$placa' and ts_inspecao_fim = '$data' or ts_inspecao_inicio = '$data'";
		$sql = new sql($query);
                $query2 = $this->Query($sql);
                return $query2->result[0][0]; 
        }
        
        public function retornIDaMotorista($idMotorista, $inspecao){
            $query.= "id_inspecao
	        FROM vei_inspecao
                where id_motorista = $idMotorista and id_inspecao = $inspecao";
		$sql = new sql($query);
                $query2 = $this->Query($sql);
                if($query2->result[0][0]){
                    $ret = true;
                }else{
                    $ret = false;
                }
                return $ret;
        }
        
        function GetByIDMotorista($idInspecao, $idMotorista)
    {
        $criteria =  $this->getCriteria();
        $criteria->AddColumnAttribute('id_veiculo');
        $criteria->addCriteria('id_inspecao','=', "$idInspecao");
        $criteria->addCriteria('id_motorista','=', "$idMotorista");
        $result = $criteria->retrieveAsQuery();
        return $result->result[0][0];
    }
       
}
?>
