<?
MIOLO::Import('modules::protocolo::controls::linkprocesso');
class gridBuscaAvancada extends MDataGrid2
{
    protected $processo;
	protected $fazerbusca = false;
    function __construct()
    {        
        global $MIOLO, $module, $page, $context, $self, $action, $perms, $state;   
      //  global $MIOLO, $module, $page, $self;
        $lista = Form::GetFormValue('lista');
        $numero = Form::GetFormValue('numero');         
        $tipo = Form::GetFormValue('tipo');
        $titulo = Form::GetFormValue('titulo');
        $assunto = Form::GetFormValue('assunto');
        $solicitante = Form::GetFormValue('solicitante');
        $autor = Form::GetFormValue('autor');
        $instituicao = Form::GetFormValue('instituicao');
        $dataInicio = Form::GetFormValue('dataInicio');
        $dataFim = Form::GetFormValue('dataFim');
        $setorAtual = Form::GetFormValue('setorAtual');       
        $setorOrigem = Form::GetFormValue('setorOrigem');
        $setorParticipante = Form::GetFormValue('setorParticipante');
        $cxArquivo = Form::GetFormValue('cxArquivo');
        $busca = Array('numero'=>$numero,'tipo'=>$tipo,'titulo'=>$titulo,'assunto'=>$assunto,'solicitante'=>$solicitante,'autor'=>$autor,'instituicao'=>$instituicao,
                       'dataInicio'=>$dataInicio,'dataFim'=>$dataFim,'setorAtual'=>$setorAtual,'setorOrigem'=>$setorOrigem,'setorParticipante'=>$setorParticipante,'cxArquivo'=>$cxArquivo);
        //11/04/2012 Tiago Macedo
		foreach($busca as $elemento){
			if ($elemento != ''){
				$fazerbusca = true;
			}
		}//parrei aqui
		//$href_grid = $MIOLO->GetActionURL($module,$self,  $this->processo->titulo, Array('form'=>'ProcessosFind','event'=>'btnList_click'));
        $linkprocesso = new LinkProcesso('linkprocesso','%0%');
        $this->processo = $MIOLO->GetBusiness('protocolo','processo');
        // busca
        if (Form::GetFormValue('__EVENTTARGETVALUE'))
        {
            $listaPor = Form::GetFormValue('listaPor');
            if ($listaPor)				
            {				
                switch($lista)
                {
                    case 'decisao':
                        $query = $this->processo->ListSemDecisaoBySetor($listaPor);
                    break;
                    case 'saida':
                        $query = $this->processo->ListSaidaBySetor($listaPor);
                    break;
                    case 'entrada':
                        $query = $this->processo->ListEntradaBySetor($listaPor);
                    break;
                    default:
                        unset($listaPor);
                        $query = $this->processo->ListEntradaBySetor($listaPor);
                    break;
                }
            }
            else
            {
                unset($listaPor);
                $query = $this->processo->buscaAvancada($busca);
            }
        }
        else
        {                          
                   $query = $this->processo->buscaAvancada($busca);
        }
        $this->SetFilter(false);
        $this->SetIndex(1);
        $columns = array( new MDataGridControl($linkprocesso,'numpro','Numero','center','','20%'),new MDataGridColumn('titulo','Título','',false,'30%'),
                          new MDataGridColumn('assunto','Assunto','',false,'30%'),new MDataGridColumn('interes','Solicitante','',false,'20%') );
		//11/04/2012 Tiago Macedo
		if ($fazerbusca){
			parent::__construct($query, $columns, $href_grid,25);
		}
        $this->SetLinkType('hyperlink');        
        $this->width = '100%';
        $this->eventHandler();		
    }
    function GenerateFooter()
    {
        if (!$this->data) $footer[] = $this->GenerateEmptyMsg();
        return $footer;
    }
}
?>