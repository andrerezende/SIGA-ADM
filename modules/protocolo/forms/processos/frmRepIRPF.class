<?php
// 12/05/2011 Daniel Bonfim
class frmRepIRPF extends MForm {
	public function __construct() {
		parent::__construct('Relatório de Processo');
		$this->EventHandler();
		$this->defaultButton = false;
	}

	public function CreateFields() {
		global $MIOLO, $module, $action, $item, $theme;

        $fields = array(            
            new MSelection('slAno', '','Ano',$this->geraAnos()),
            new MLookupTextField('instituicao', '', 'Instituição', 30, NULL, NULL, NULL, 'common', 'instituicao2'),
            new MHiddenField('idInstituicao'),
            new MHiddenField('sigla'),
		);
        $this->SetFields($fields);

        $this->SetFieldAttr('instituicao', 'related', 'idInstituicao,instituicao,sigla');

        $buttons = array(
			new MButton('btnPost', 'Gerar Relatório', 'PDF'),
		);
		$this->SetButtons($buttons);
	}

	public function btnPost_click() {
		global $MIOLO, $module, $item;

		// para o cabeçalho
		$report = new MJasperReport('sigaept');
		$parameters['SUBREPORT_DIR'] = $MIOLO->GetConf('home.modules');
		$parameters['pIdUsuario'] = $MIOLO->login->idkey;
		$parameters['pURL'] = $MIOLO->GetConf('home.url');

		$instituicao = $this->GetFormValue('instituicao');
		$idInstituicao = $this->GetFormValue('idInstituicao');
		$ano = $this->GetFormValue('slAno');

		if (empty($instituicao)) {
			$this->addError("Selecione a instituição.");
			return false;
		} elseif(empty($ano)) {
			$this->addError("Selecione o ano.");
			return false;
		}
        
        $parameters['pIdInstituicao'] = $idInstituicao;
        $parameters['pAno'] = $ano;
        
        
        $report->Execute($module, 'repProcesso', $parameters);
  	}

    public function geraAnos() {
		$anos = array();
		$anoAtual = date('Y');
		$anoInicial = $anoAtual - 40;
		for ($i = $anoAtual; $i >= $anoInicial; --$i) {
			$anos[(int) $i] = (int) $i;
		}
		return $anos;
	}
}